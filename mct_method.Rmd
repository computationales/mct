---
title: "Mass Curve Technique, Gao et al."
author: "Beni Stocker"
date: "4/30/2019"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rbeni)
library(lubridate)
# library(survival)
# library(SPREDA)
library(extRemes)
source("R/eva_max.R")
source("R/mct2.R")
source("R/get_plantwhc_mct_bysite.R")
source("R/convert_et.R")
```

Code for this is available on [my github](https://github.com/stineb/mct).

## Approach

Gao et al. (2014) suggest that the plant rooting is adapted to the cumulative water deficit during the dry spells They adopt the Mass Curve Technique to derive it. A Gumbel distribution is fit to the accumulated water deficits during dry spells and allows for an estimate of the deficit with a given return period. The method requires precipitation ($P$), runoff ($Q$), potential evapotranspiration ($E_p$) and green vegetation cover ($f_v$) to be specified for each time step (here daily) over multiple years.

The approach implemented here (function `mct()`) considers temporal variations in the demand, while Gao et al. calculated a mean annual and mean dry season demand. Here, PET is calculated based on the Priestly-Taylor equation as opposed to the Hargreaves equation used by Gao et al. Limitations of the method described here include that lateral runon and runoff and delayed water inflow by snow melt are ignored, and PET is assumed to drive the demand but is not affected by other plant adaptations to dry conditions (reduction of stomatal conductance, internal water storage). Effects of phenological changes on water demand during droughts are accounted for by $f_v$.

The steps for the method are:

1. Identify events where the water deficit ($ET - P$) is accumulating. 
2. Fit a gumbel distribution to the largest $N$ events.
3. Extract the estimated water deficit for a given return period $T$.

## Identify CWD events

### Get FLUXNET data

Let's try this out for the FLUXNET site 'FR-Pue', for which whe have these variables. Read FLUXNET meteo data from FLUXNET stations (and  years), written by `rscript_eval_fluxnet2015.R`.
```{r}
## meteo data 
load("./data/ddf_meteo.Rdata")

## re-read ET data from FLUXNET and don't remove (filter) any data
filn <- "data/ddf_eval_all.Rdata"
if (!file.exists(filn)){
  ddf_eval <- ingest(
    siteinfo = siteinfo,
    source    = "fluxnet", 
    getvars   = list(latenth = "LE_F_MDS", latenth_qc = "LE_F_MDS_QC", gpp = "GPP_NT_VUT_REF"),
    dir       = "~/data/FLUXNET-2015_Tier1/20191024/DD/",
    settings  = list(threshold_GPP = 0.8, threshold_LE = 0.0, getswc = FALSE, filter_ntdt = TRUE, remove_neg = FALSE),
    timescale = "d"
  )
  save(ddf_eval, file = filn)
} else {
  load(filn)
}

## combine FLUXNET meteo and ET data
ddf_fluxnet <- ddf_meteo %>% 
  unnest(data) %>% 
  left_join(ddf_eval %>% 
              unnest(data), 
            by = c("sitename", "date")
            ) %>% 
  group_by(sitename) %>% 
  nest() %>% 
  
  ## nest elv into data frame
  left_join(
    readr::read_csv("~/ingestr/siteinfo_fluxnet2015.csv") %>% 
      dplyr::select(sitename, elv),
    by = "sitename"
  ) %>% 
  unnest(data) %>% 
  group_by(sitename) %>% 
  nest() %>% 
  
  ## convert units: get ET in mm d-1
  dplyr::mutate(latenth_mm = purrr::map(data, ~convert_et(.$latenth, .$temp, .$elv))) %>% 
  dplyr::mutate(latenth_mm = purrr::map(latenth_mm, ~tibble(latenth_mm = .))) %>% 
  dplyr::mutate(data       = purrr::map2(data, latenth_mm, ~bind_cols(.x, .y))) %>% 
  dplyr::select(-latenth_mm)
```
 
### Get ALEXI/WATCH-WFDEI data

Read ALEXI ET and WATCH-WFDEI data at FLUXNET sites, written by `rscript_get_data_fluxnetsites.R`.
```{r}
load("data/df_alexi.Rdata")
```

### Plot water balance components

```{r}
ddf_fluxnet %>%
  filter(sitename == "US-Ton") %>% 
  unnest(data) %>% 
  ggplot(aes(date, prec)) +
  geom_line(color = "royalblue") +
  labs(x = "Date", y = expression(paste("Precipitation (mm d"^{-1}, ")")) )
#ggsave("fig/prec_example.pdf", width = 6, height = 3)

ddf_fluxnet %>% 
  filter(sitename == "US-Ton") %>% 
  unnest(data) %>% 
  ggplot(aes(date, latenth_mm)) +
  geom_line(color = "tomato") +
  labs(x = "Date", y = expression(paste("ET (J m"^{-2}, "d"^{-1}, ")")) )
#ggsave("fig/pet_example.pdf", width = 6, height = 3)

ddf_fluxnet %>% 
  filter(sitename == "US-Ton") %>% 
  unnest(data) %>% 
  mutate(latenth_mm = ifelse(is.na(latenth_mm), 0, latenth_mm)) %>% 
  ggplot(aes(date, -cumsum(prec - latenth_mm))) +
  geom_line(color = "black") +
  labs(x = "Date", y = expression(paste("Water balance (mm d"^{-1}, ")")) )
```

Calculate daily water balance and add to test data frame for site US-Ton. 
```{r}
df_example_fluxnet <- ddf_fluxnet %>% 
  filter(sitename == "US-Ton") %>% 
  unnest(data) %>% 
  mutate(latenth_mm = ifelse(is.na(latenth_mm), 0, latenth_mm)) %>% 
  mutate(bal = prec - latenth_mm) %>% 
  mutate(bal = myapprox(bal)) %>% 
  mutate(bal_cum    = cumsum(bal)) %>% 
  mutate(demand_cum = cumsum(latenth_mm)) %>% 
  mutate(supply_cum = cumsum(prec))

df_example_alexi <- df_alexi %>% 
  filter(idx == "US-Ton") %>% 
  unnest(df) %>% 
  mutate(et_mm = ifelse(is.na(et_mm), 0, et_mm)) %>% 
  mutate(bal = prec - et_mm) %>% 
  mutate(bal = myapprox(bal)) %>% 
  mutate(bal_cum    = cumsum(bal)) %>% 
  mutate(demand_cum = cumsum(et_mm)) %>% 
  mutate(supply_cum = cumsum(prec)) %>% 
  drop_na(bal) %>% 
  
  ## merge FLUXNET GPP and PPFD data into the alexi data frame
  left_join(
    df_example_fluxnet %>% 
      ungroup() %>% 
      dplyr::select(date, gpp, ppfd),
    by = "date"
  )
```


### CWD events

Get events of consecutive deficit using the `mct()` function.
```{r}
out_mct_fluxnet <- mct(df_example_fluxnet, varname_wbal = "bal", thresh_terminate = 0.1, thresh_drop = 0.9 )
out_mct_alexi   <- mct(df_example_alexi,   varname_wbal = "bal", thresh_terminate = 0.1, thresh_drop = 0.9 )
```

Plot the cumulative deficit and rain events.
```{r}
## cumulative deficits
## FLUXNET data
ggplot() +
  geom_rect(
    data=out_mct_fluxnet$inst, 
    aes(xmin=date_start, xmax=date_end, ymin=-99, ymax=99999), 
    fill=rgb(0,0,0,0.3), 
    color=NA) +
  geom_line(data = out_mct_fluxnet$df, aes(date, prec), size = 0.3, color="royalblue") +
  geom_line(data = out_mct_fluxnet$df, aes(date, deficit), color="tomato") +
  geom_line(data = out_mct_fluxnet$df, aes(date, 100 * (gpp/ppfd))) +
  coord_cartesian(ylim=c(0, 200), xlim = c(ymd("2002-01-01"), ymd("2010-12-01"))) +
  theme_classic() +
  labs(title = "US-Ton", subtitle = "ET and precipitation: FLUXNET", x = "Date", y = "Cumulative water deficit (mm)")
ggsave("fig/cwd_example_fluxnet.pdf", width = 6, height = 3)

## ALEXI data
ggplot() +
  geom_rect(
    data=out_mct_alexi$inst, 
    aes(xmin=date_start, xmax=date_end, ymin=-99, ymax=99999), 
    fill=rgb(0,0,0,0.3), 
    color=NA) +
  geom_line(data = out_mct_alexi$df, aes(date, prec), size = 0.3, color="royalblue") +
  geom_line(data = out_mct_alexi$df, aes(date, deficit), color="tomato") +
  geom_line(data = out_mct_fluxnet$df, aes(date, 100 * (gpp/ppfd))) +
  coord_cartesian(ylim=c(0, 300)) + # , xlim = c(ymd("2002-01-01"), ymd("2010-12-01"))
  theme_classic() +
  labs(title = "US-Ton", subtitle = "ET: ALEXI, precipitation: WATCH-WFDEI", x = "Date", y = "Cumulative water deficit (mm)")
ggsave("fig/cwd_example_alexi.pdf", width = 6, height = 3)

## ALEXI and FLUXNET data on top of each other
ggplot() +
  geom_line(data = out_mct_fluxnet$df, aes(date, deficit), color="black") +
  geom_line(data = out_mct_alexi$df, aes(date, deficit), color="tomato")
```

### LUE vs. CWD

This shows that GPP/PAR declines as the CWD increases during large CWD events. Let's retain only data from the largest $N$ events and plot GPP/PAR vs. CWD.

For FLUXNET data:
```{r}
## retain only data from largest instances
nyears <- out_mct_fluxnet$df %>% 
  mutate(year = year(date)) %>% 
  pull(year) %>% 
  unique() %>% 
  length()
biginstances <- out_mct_fluxnet$inst %>% 
  arrange(-deficit) %>% 
  slice(1:nyears) %>% 
  pull(iinst)

## get linear fit with outliers
linmod <- lm(lue ~ deficit, data = out_mct_fluxnet$df %>% mutate(lue = gpp/ppfd))
idx_drop <- which(is.na(remove_outliers(linmod$residuals, coef = 1.5)))
out_mct_fluxnet$df_clean <- out_mct_fluxnet$df %>% 
  mutate(lue = gpp/ppfd)
out_mct_fluxnet$df_clean$lue[idx_drop] <- NA

## git linear fit without outliers
linmod <- lm(lue ~ deficit, data = out_mct_fluxnet$df_clean)

## test: is slope negative?
is_neg <- coef(linmod)["deficit"] < 0.0

## test: is slope significantly (5% level) different from zero (t-test)?
coef(summary(linmod))["deficit", "Pr(>|t|)"] < 0.05

## get x-axis cutoff
lue0 <- - coef(linmod)["(Intercept)"] / coef(linmod)["deficit"]
df_fit = data.frame(y = predict(linmod, newdata = out_mct_fluxnet$df_clean), x = out_mct_fluxnet$df_clean$deficit)

## plot
out_mct_fluxnet$df_clean %>% 
  filter(iinst %in% biginstances) %>% 
  ggplot(aes(x = deficit, y = gpp/ppfd)) +
  geom_point(alpha = 0.5) +
  labs(title = "US-Ton", x = "Cumulative water deficit (mm)", y = "GPP/PPFD", subtitle = "ET: FLUXNET, precipitation: FLUXNET, GPP: FLUXNET, PPFD: FLUXNET") +
  geom_vline(xintercept = lue0, linetype = "dotted") +
  geom_line(data = df_fit, aes(x, y), col = "red")
```

For ALEXI data:
```{r}
nyears <- out_mct_alexi$df %>% 
  mutate(year = year(date)) %>% 
  pull(year) %>% 
  unique() %>% 
  length()
biginstances <- out_mct_alexi$inst %>% 
  arrange(-deficit) %>% 
  slice(1:nyears) %>% 
  pull(iinst)

## get linear fit with outliers
linmod <- lm(lue ~ deficit, data = out_mct_alexi$df %>% mutate(lue = gpp/ppfd))
idx_drop <- which(is.na(remove_outliers(linmod$residuals, coef = 1.5)))
out_mct_alexi$df_clean <- out_mct_alexi$df %>% 
  mutate(lue = gpp/ppfd)
out_mct_alexi$df_clean$lue[idx_drop] <- NA

## git linear fit without outliers
linmod <- lm(lue ~ deficit, data = out_mct_alexi$df_clean)

## test: is slope negative?
is_neg <- coef(linmod)["deficit"] < 0.0

## test: is slope significantly (5% level) different from zero (t-test)?
coef(summary(linmod))["deficit", "Pr(>|t|)"] < 0.05

## get x-axis cutoff
lue0 <- - coef(linmod)["(Intercept)"] / coef(linmod)["deficit"]
df_fit = data.frame(y = predict(linmod, newdata = out_mct_alexi$df_clean), x = out_mct_alexi$df_clean$deficit)

## plot
out_mct_alexi$df_clean %>% 
  filter(iinst %in% biginstances) %>% 
  ggplot(aes(x = deficit, y = gpp/ppfd)) +
  geom_point(alpha = 0.5) +
  labs(title = "US-Ton", x = "Cumulative water deficit (mm)", y = "GPP/PPFD", subtitle = "ET: ALEXI, precipitation: WATCH-WFDEI, GPP: FLUXNET, PPFD: FLUXNET") +
  geom_vline(xintercept = lue0, linetype = "dotted") +
  geom_line(data = df_fit, aes(x, y), col = "red")
```

<!-- ### Evaluate ALEXI ET and WATCH-WFDEI ET -->

<!-- Apparently, at least for this site, ALEXI-based data appears to be biased high compared to FLUXNET data. Check whether this is due to precipitation or ET. -->
<!-- ```{r} -->
<!-- df_example_alexi %>%  -->
<!--   rename(sitename = idx, prec_watch = prec) %>%  -->
<!--   inner_join( -->
<!--     df_example_fluxnet %>%  -->
<!--       rename(prec_fluxnet = prec), -->
<!--     by = c("sitename", "date") -->
<!--   ) %>%  -->
<!--   rbeni::analyse_modobs2("prec_fluxnet", "prec_watch") -->

<!-- df_example_alexi %>%  -->
<!--   rename(sitename = idx, prec_watch = prec) %>%  -->
<!--   inner_join( -->
<!--     df_example_fluxnet %>%  -->
<!--       rename(prec_fluxnet = prec), -->
<!--     by = c("sitename", "date") -->
<!--   ) %>%  -->
<!--   rbeni::analyse_modobs2("latenth_mm", "et_mm") -->
<!-- ``` -->

<!-- As an additional illustration, plot cumulative variables. -->
<!-- ```{r} -->
<!-- ggplot() + -->
<!--   geom_rect( -->
<!--     data=out$`US-Ton`$inst,  -->
<!--     aes(xmin=date_start, xmax=date_end, ymin=-99, ymax=99999),  -->
<!--     fill=rgb(0,0,0,0.3),  -->
<!--     color=NA) +  -->
<!--   geom_line(data=df_example_alexi, aes(date, demand_cum)) + -->
<!--   geom_line(data=df_example_alexi, aes(date, cumsum(prec), color="supply_cum"), color="tomato") + -->
<!--   # labs(y=expression(integral(f[v] ~ E[p])), x="Date") + -->
<!--   labs(y=expression(integral(ET)), x="Date") + -->
<!--   coord_cartesian(ylim=c(0, 10000)) + -->
<!--   theme_classic() -->
<!-- ``` -->

### Distribution of CWD events

Plot the distribution of cumulative deficits (this is actually the maximum CWD attained during each event).
```{r}
ggplot() +
  geom_histogram(
    data = out_mct_fluxnet$inst,
    aes(x = deficit, y = ..density..),
    color = "black", alpha = 0.5, fill = "black",
    position="identity") +
  geom_histogram(
    data = out_mct_alexi$inst,
    aes(x = deficit, y = ..density..),
    color = "black", alpha = 0.5, fill = "tomato", 
    position="identity") +
  labs(title = "US-Ton", x = "Cumulative water deficit (mm)")

  scale_fill_manual(name = "", values = c("black", "tomato"), labels = c("FLUXNET", "ALEXI/WATCH-WFDEI"))
```

## Fit an extreme value distribution

To estimate the probability of extreme values, we fit a Gumbel distribution following [this link](http://blogs2.datall-analyse.nl/2016/02/17/extreme_value_analysis_maxima/#more-120). A paper on the R package [extRemes](file:///Users/benjaminstocker/Downloads/v72i08.pdf).
```{r}
## Take only the N largest instances (deficits), where N is given by the number of years available in the data
nyears <- year(range(out_mct_alexi$df$date)[2]) - year(range(out_mct_alexi$df$date)[1]) + 1
vals <- out_mct_alexi$inst %>% 
  arrange(desc(deficit)) %>% 
  dplyr::slice(1:nyears) %>%  # use all data!
  dplyr::select(deficit) %>% 
  pull()

gumbi <- extRemes::fevd(x=vals, type="Gumbel", method="MLE")
summary(gumbi)

pdf("fig/gumbi_example.pdf", width = 8, height = 7)
pl <- plot(gumbi)
dev.off()

# extract MLEs (these are needed for the remaining part of the analysis)
muG <- gumbi$results$par[1]
sigmaG <- gumbi$results$par[2]

## don't know which package these are coming from (e1071?)
probplot(values=vals, model=gumbi, varname="Deficit (mm)", alpha=1-0.95, dist="gumbel")
#cprobplot(values=vals, model=gumbi, varname="Deficit (mm)", alpha=1-0.95, dist="gumbel")

QQplot(values=vals, mu=muG, sigma=sigmaG, dist="gumbel")
PPplot(values=vals, mu=muG, sigma=sigmaG, dist="gumbel")

# all plots ("primary")
# extRemes::plot.fevd(gumbi)

# only return period plot
plot.fevd.mle(gumbi, 
      # type = c("primary", "probprob", "qq", "qq2", "Zplot", "hist", "density", "rl", "trace"),
      type = c("rl"),
      rperiods = c(2, 5, 10, 20, 50, 80, 100, 120, 200, 250, 300, 500, 800),
      a = 0, hist.args = NULL, density.args = NULL, d = NULL )

source("R/get_return_period.R")
df_test <- get_return_period(gumbi)
with(df_test, plot(trans_period, return_values, pch=16, col="red"))
```

### Extract value for return periods

Get tranformed variate of return period $T$ as described in Gao et al. as
$$
y = - \ln ( -\ln (1-1/T) )
$$

```{r}
## get return levels for a given vector of return periods
return_period <- c(2, 5, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 200, 250, 300, 500, 800)
return_level <- extRemes::return.level(
  gumbi, 
  return.period = return_period
  )
df_return <- tibble( 
  return_period = return_period, 
  return_level = unname(c(return_level)), 
  trans_period = -log( -log(1 - 1/return_period)) )

df_return %>% 
  ggplot(aes(trans_period, return_level)) +
  geom_point()
```

### Nice functions

Fitting the extreme value distribution and estimating the event size with return period $T$ is done in one single function.
```{r}
result <- get_plantwhc_mct_bysite(df_example_alexi, varname_wbal = "bal")
result

result <- get_plantwhc_mct_bysite(df_example_fluxnet, varname_wbal = "bal")
result
```

Let's visualise the estimated event size with a return period of $T = 20$ y on top of the distribution of cumulative water deficit events.
```{r}
mct_alexi   <- get_plantwhc_mct_bysite(df_example_alexi,   varname_wbal = "bal", thresh_terminate = 0.2, thresh_drop = 0.8)
mct_fluxnet <- get_plantwhc_mct_bysite(df_example_fluxnet, varname_wbal = "bal", thresh_terminate = 0.2, thresh_drop = 0.8)

ggplot() +
  geom_histogram(
    data = out_mct_fluxnet$inst,
    aes(x = deficit, y = ..density..),
    color = "black", alpha = 0.5, fill = "black",
    position="identity") +
  geom_histogram(
    data = out_mct_alexi$inst,
    aes(x = deficit, y = ..density..),
    color = "black", alpha = 0.5, fill = "tomato", 
    position="identity") +
  labs(title = "US-Ton", x = "Cumulative water deficit (mm)") +
  geom_vline(xintercept = mct_fluxnet %>% filter(return_period == 20) %>% pull(return_level), col = "black") +
  geom_vline(xintercept = mct_alexi %>% filter(return_period == 20) %>% pull(return_level), col = "tomato")

  scale_fill_manual(name = "", values = c("black", "tomato"), labels = c("FLUXNET", "ALEXI/WATCH-WFDEI"))
```

## LUE vs. CWD with gumbi line

We expect that LUE $=$ GPP$/$PAR declines with increasing CWD. Let's align LUE at the onset of the largest few CWD events for one site.

### ALEXI/WATCH-WFDEI data
```{r}
nyears <- out_mct_alexi$df %>% 
  mutate(year = year(date)) %>% 
  pull(year) %>% 
  unique() %>% 
  length()
biginstances <- out_mct_alexi$inst %>% 
  arrange(-deficit) %>% 
  slice(1:nyears) %>% 
  pull(iinst)

out <- out_mct_alexi$df %>% 
  filter(iinst %in% biginstances) %>% 
  ggplot(aes(x = deficit, y = gpp/ppfd)) +
  geom_point(alpha = 0.5) +
  labs(title = "US-Ton", x = "Cumulative water deficit (mm)", y = "GPP/PPFD", subtitle = "ET: ALEXI, precipitation: WATCH-WFDEI, GPP: FLUXNET, PPFD: FLUXNET") +
  geom_smooth(aes(y =  gpp/ppfd), color = 'red', method = 'lm', se = TRUE)
if (!identical(mct_alexi, NA)){
  mct20 <- mct_alexi %>% filter(return_period == 20) %>% pull(return_level)
  if (!is.na(mct20)){
    out +
      geom_vline(xintercept = mct20, col = "tomato")
  } else {
    rlang::warn(paste("No ALEXI MCT outputs for site", sitename))
  }
} else {
  rlang::warn(paste("No ALEXI MCT outputs for site", sitename))
}
out

  
# ## get into standard format, with 'idx_start' and 'len' as columns
# events_fluxnet <- out_mct_fluxnet$df %>%  
#   ungroup() %>% 
#   dplyr::mutate( idx = 1:n() ) %>% 
#   dplyr::select(date_start = date, idx) %>% 
#   right_join(
#     out_mct_fluxnet$inst,
#     by = "date_start"
#   ) %>% 
#   dplyr::select(idx_start = idx, len) %>% 
#   filter(len > 14)
# 
# ## add CWD to data frame
# df_example_fluxnet <- df_example_fluxnet %>% 
#   left_join(
#     out_mct_fluxnet$df %>% 
#       ungroup() %>% 
#       dplyr::select(date, deficit),
#     by = "date"
#   )
# 
# ## retain only data that is in a CWD event
# df_alg_fluxnet <- df_example_fluxnet %>%
#   dplyr::ungroup() %>% 
#   align_events(
#     events         = events_fluxnet,
#     dovars         = c("gpp", "deficit"), 
#     leng_threshold = 14, 
#     before         = 10, 
#     after          = 30, 
#     nbins          = 4, 
#     do_norm        = FALSE
#     )
# 
# df_alg_fluxnet$df_dday %>% 
#   dplyr::filter(dday>2) %>% 
#   ggplot(aes(x = deficit, y = gpp/ppfd)) +
#   geom_point(alpha = 0.5) +
#   labs(title = "US-Ton", x = "Cumulative water deficit (mm)", y = "GPP/PPFD", subtitle = "ET: FLUXNET, precipitation: FLUXNET, GPP: FLUXNET, PPFD: FLUXNET") +
#   geom_smooth(aes(y =  gpp/ppfd), color = 'tomato', method = 'loess', se = TRUE) +
#   geom_vline(xintercept = mct_fluxnet %>% filter(return_period == 20) %>% pull(return_level), col = "tomato")
```

<!-- ### ALEXI/WATCH-WFDEI data -->
<!-- ```{r} -->
<!-- ## get into standard format, with 'idx_start' and 'len' as columns -->
<!-- events_alexi <- out_mct_alexi$df %>%   -->
<!--   ungroup() %>%  -->
<!--   dplyr::mutate( idx = 1:n() ) %>%  -->
<!--   dplyr::select(date_start = date, idx) %>%  -->
<!--   right_join( -->
<!--     out_mct_alexi$inst, -->
<!--     by = "date_start" -->
<!--   ) %>%  -->
<!--   dplyr::select(idx_start = idx, len) %>%  -->
<!--   filter(len > 14) -->

<!-- ## merge CWD to alexi data frame -->
<!-- df_example_alexi_tmp <- df_example_alexi %>%  -->
<!--   left_join( -->
<!--     out_mct_alexi$df %>% -->
<!--       ungroup() %>% -->
<!--       dplyr::select(date, deficit), -->
<!--     by = "date" -->
<!--   ) -->

<!-- ## retain only data that is in a CWD event -->
<!-- df_alg_alexi <- df_example_alexi_tmp %>% -->
<!--   dplyr::ungroup() %>%  -->
<!--   align_events( -->
<!--     events         = events_alexi, -->
<!--     dovars         = c("gpp", "deficit"),  -->
<!--     leng_threshold = 20,  -->
<!--     before         = 10,  -->
<!--     after          = 30,  -->
<!--     nbins          = 4,  -->
<!--     do_norm        = FALSE -->
<!--     ) -->

<!-- df_alg_alexi$df_dday %>%  -->
<!--   # dplyr::filter(dday>2) %>%  -->
<!--   ggplot(aes(x = deficit, y = gpp/ppfd)) + -->
<!--   geom_point(alpha = 0.5) + -->
<!--   labs(title = "US-Ton", x = "Cumulative water deficit (mm)", y = "GPP/PPFD", subtitle = "ET: ALEXI, precipitation: WATCH-WFDEI, GPP: FLUXNET, PPFD: FLUXNET") + -->
<!--   geom_smooth(aes(y =  gpp/ppfd), color = 'tomato', method = 'loess', se = TRUE) + -->
<!--   geom_vline(xintercept = mct_alexi %>% filter(return_period == 20) %>% pull(return_level), col = "tomato") -->
<!-- ``` -->

## Methods evaluation at all sites

All of the above evaluated steps are implemented in one function, producing plot files for each site separately.
```{r}
filn <- "data/out.Rdata"
if (!file.exists(filn)){
  allsites <- ddf_fluxnet %>% 
    pull(sitename)
  out <- list()
  for (site in allsites){
   out[[site]] <- test_mct_bysite(
     site,
     ddf_fluxnet %>% 
      filter(sitename == site), 
     df_alexi %>% 
       filter(idx == site),
     thresh_terminate = 0.1, 
     thresh_drop = 0.9,
     use_return_period = 10
   )
  }
  save(out, file = "data/out.Rdata")
} else {
  load(filn)
}

## for some reason, purrr::map() did not work here.
```

Some evaluations across all sites.
```{r eval=FALSE}
allsites <- ddf_fluxnet %>% 
  pull(sitename)
df_corr_fluxnet <- tibble(lue0 = purrr::map_dbl(out, "lue0_fluxnet"), mct20 = purrr::map_dbl(out, "mct20_fluxnet")) %>% 
  mutate(sitename = allsites)
df_corr_alexi <- tibble(lue0 = purrr::map_dbl(out, "lue0_alexi"), mct20 = purrr::map_dbl(out, "mct20_alexi")) %>% 
  mutate(sitename = allsites)

df_corr_fluxnet %>% 
  filter(lue0 < 1000 & mct20 < 1000) %>% 
  rbeni::analyse_modobs2("lue0", "mct20")

df_corr_alexi %>% 
  filter(lue0 < 1000 & mct20 < 1000) %>% 
  rbeni::analyse_modobs2("lue0", "mct20")
```