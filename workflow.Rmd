---
title: "Workflow"
author: "Beni Stocker"
date: "6/8/2020"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(rbeni)
library(tidyr)
library(purrr)
library(ncdf4)
library(lubridate)
library(ggplot2)
library(readr)
#library(rsofun)
#library(ingestr)
library(stringr)
library(ggridges)
# library(rgdal)
library(broom)
library(cowplot)

#files.sources = list.files("./R")
#out <- sapply(paste0("R/", files.sources), source)
```

## Overview

This workflow can be applied irrespective of the site set or global gridcells. Just need a "grid data frame".

1.  **Get site/grid meta info** → data frame with all meta info variables as separate columns

    -   elevation

        -   Site scale: data or ETOPO1
        -   Global: WFDEI

    -   soil texture, derive WHC top and bottom, and record obstacles to root used in function `calc_zroot.R`

        -   Site scale: HWSD
        -   Global: HWSD-Wieder

    -   WTD, Fan et al.

        -   Site scale: Hi-res Fan
        -   Global: Lo-res Fan

    -   Biome, WWF, NSCP?

        -   Site scale: WWF, extract from shapefile
        -   Global: rasterize WWF data?

2.  **Extract data**, `rscript_get_data.R` → separate data frames for each data source, rows: site/gridcell, column: nested data, data: ET (W m-2), prec, snow, temp, elevation; large data! need to separate data frames by chunks for global analyses

    -   ALEXI
    -   WATCH
    -   SIF
    -   GLASS net radiation

3.  **Convert units, complement, reduce** → Manipulates data frames prepared by step 2, reduced data frames with only 1 column: daily water balance (not cumulative!)

    -   ET to mm (done in step 1)
    -   Snow water balance

4.  **CWD events**, `mct2.R` → list with (i) water deficit time series, daily and cumulative, dday, iinst; and (ii) events data frame with maximum deficit, start date and length of event

    -   Use parameters determined from FLUXNET-sites analysis (`thresh_terminate = 0.0, thresh_drop = 0.9`)

5.  **Water deficit extremes CWDX** (maximum event with N year return period), `get_plantwhc_mct_bysite.R` → data frame with return periods

    -   Use 20 year return period for good match of obs and mod at SJ02 sites (see ridges plot)

6.  **Rooting depth z(CWDX)**, see `mct_sj02_simsuite.Rmd` → data frame with z(CWDX) for different return periods

    -   Use meta info prepared in step 1, including WTD (Fan), see `mct_sj02_simsuite.Rmd`

7.  **Implied zroot using SiF: CWD(LUE=0)**, see `test_mct_bysite_alexi_fluxnet.R`

    -   Use CWD events from step 3 and SiF from step 2

8.  **Implied zroot using Rn: CWD(fET=0)**, see `test_mct_bysite_alexi_fluxnet.R`

    -   Use CWD events from step 3 and GLASS net radiation from step 2

## Settings

The same overall workflow can be used for different site sets or for global simulations (treating each gridcell as a site). Depending on this scale, some data is read from different sources.

Define which set is used by uncommenting/commenting:

```{r}
siteset <- "sj02"
# siteset <- "global"
# siteset <- "fluxnet2015"
# siteset <- "rsip"
```

## Vegetation mask

Read modis landcover map for year 2011 at 0.05 degrees.
```{r}
df_vegmask <- nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.05deg__2011.nc", 
                       varnam = "urban_and_builtup") |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  dplyr::select(-time) |> 
  left_join(
    nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.05deg__2011.nc", 
                       varnam = "snowandice") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      dplyr::select(-time),
    by = c("lon", "lat")
  ) |> 
  left_join(
    nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.05deg__2011.nc", 
                       varnam = "barren_sparsely_vegetated") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      dplyr::select(-time),
    by = c("lon", "lat")
  ) |> 
  left_join(
    nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.05deg__2011.nc", 
                       varnam = "water") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      dplyr::select(-time),
    by = c("lon", "lat")
  ) |> 
  # mutate(nonveg = (urban_and_builtup + snowandice + water + barren_sparsely_vegetated)/100) |> 
  mutate(nonveg = (urban_and_builtup + snowandice + water)/100) |> 
  mutate(vegmask = ifelse(nonveg > 0.99, NA, 1))

save(df_vegmask, file = "data/df_vegmask.RData")
```

Read modis landcover map for year 2011 at 0.1 degrees.
```{r}
df_vegmask_tenthdeg <- nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.1deg__2011.nc", 
                       varnam = "urban_and_builtup") |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  dplyr::select(-time) |> 
  left_join(
    nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.1deg__2011.nc", 
                       varnam = "snowandice") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      dplyr::select(-time),
    by = c("lon", "lat")
  ) |> 
  left_join(
    nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.1deg__2011.nc", 
                       varnam = "barren_sparsely_vegetated") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      dplyr::select(-time),
    by = c("lon", "lat")
  ) |> 
  left_join(
    nc_to_df("~/data/modis_monthly-evi/zmaw_data/modis_landcover__LPDAAC__v5.1__0.1deg__2011.nc", 
                       varnam = "water") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      dplyr::select(-time),
    by = c("lon", "lat")
  ) |> 
  # mutate(nonveg = (urban_and_builtup + snowandice + water + barren_sparsely_vegetated)/100) |> 
  mutate(nonveg = (urban_and_builtup + snowandice + water)/100) |> 
  mutate(vegmask = ifelse(nonveg > 0.99, NA, 1))

save(df_vegmask_tenthdeg, file = "data/df_vegmask_tenthdeg.RData")
```

## Meta info

-   Creates data frame with all meta info variables as separate columns.

Read site location and direct observation data.

```{r}
if (siteset=="sj02"){
  ##----------------------------------------------
  ## Schenk & Jackson sites
  ##----------------------------------------------
  siteinfo <- read_csv("~/data/rootingdepth/root_profiles_schenkjackson02/data/root_profiles_D50D95.csv") |>
    dplyr::filter(Wetland == "N" & Anthropogenic == "N" & Schenk_Jackson_2002 == "YES") |> 
    dplyr::rename(sitename = ID, lat = Latitude, lon = Longitude) |> 
    dplyr::mutate(elv = ifelse(elv==-999, NA, elv)) |> 
    dplyr::filter(lon!=-999 & lat!=-999) |> 
    dplyr::select(sitename, lon, lat, elv)

  df_grid_allsiteid <- siteinfo |> 
    dplyr::select(sitename, lon, lat, elv) |> 
    dplyr::rename(idx = sitename)

  df_grid <- df_grid_allsiteid |>
    dplyr::select(lon, lat) |>
    distinct() |>
    mutate(idx = 1:n()) |>
    mutate(idx = paste0("i", idx))

} else if (siteset == "fluxnet2015"){
  ##----------------------------------------------
  ## FLUXNET 2015 Tier 1 sites
  ##----------------------------------------------
  siteinfo <- ingestr::siteinfo_fluxnet2015 |> 
    rename(sitename = mysitename) |> 
    filter(!(classid %in% c("CRO", "WET"))) |> 
    #filter(year_start<=2007) |>    # xxx USE ONLY FOR LANDEVAL xxx
    mutate(date_start = lubridate::ymd(paste0(year_start, "-01-01"))) |> 
    mutate(date_end = lubridate::ymd(paste0(year_end, "-12-31")))

  df_grid <- siteinfo |> 
    dplyr::select(sitename, lon, lat, elv) |> 
    dplyr::rename(idx = sitename)

} else if (siteset == "global"){
  ##----------------------------------------------
  ## Global simulations at 0.5 degrees
  ##----------------------------------------------
  ## use WFDEI land mask and read its elevation
  df <- nc_to_df("~/data/watch_wfdei/WFDEI-elevation.nc", dropna = TRUE) |> 
    mutate(sitename = paste0("i", 1:n())) |> 
    rename(elv = myvar) |> 
    dplyr::select(sitename, lon, lat, elv)
}
```

### Elevation

-   Fills missing values in column `elv`.

    -   Site scale: data or ETOPO1
    -   Global: WFDEI

#### Global

First, regrid ETOPO1 file and save as NetCDF (Done with `~/data/etopo/proc_etopo.R`). Then read it in.

```{r}
df_elv <- nc_to_df(
  "~/data/etopo/ETOPO1_Bed_g_gef.tif_halfdeg.nc",
  varnam = "ETOPO1_Bed_g_geotiff"
  )
```

#### Site-level

Extract points from ETOPO1 GeoTIFF file and add to siteinfo.

```{r}
library(ingestr)

if (siteset != "global"){
  ##----------------------------------------------
  ## Site-scale set
  ##----------------------------------------------
  siteinfo <- siteinfo |> 
    left_join(
      ingest(
        siteinfo |> 
          dplyr::select(sitename, lon, lat, elv) |> 
          distinct(),
        source = "etopo1",
        dir = "~/data/etopo/"
        ) |> 
        unnest(data) |> 
        rename(elv_etopo = elv),
      by = "sitename"
    )

  ## Show a comparison
  modobs_elv <- siteinfo |> 
    analyse_modobs2("elv", "elv_etopo")
  modobs_elv$gg

  ## Replace missing
  siteinfo <- siteinfo |> 
    mutate(source_elv = ifelse(is.na(elv), "etopo1", "orig_data")) |> 
    mutate(elv = ifelse(is.na(elv), elv_etopo, elv)) |> 
    dplyr::select(-elv_etopo)
}
```

### Soil texture

-   Derive WHC top and bottom, and record obstacles to root used in function `calc_zroot.R`. Adds columns `data_soiltext_top` and `data_soiltext_sub`.

    -   Site scale: HWSD
    -   Global: HWSD-Wieder

#### Global

Get data from rasterized HWSD data by Wieder. Data frame has row for each gridcell and nested data frames in `data`, containing columns `T_CLAY, T_GRAVEL, T_OC, T_SAND, S_CLAY, S_GRAVEL, S_OC, S_SAND, ROOTS, IL`

```{r}
## first get subsoil parameters
df_hwsd <- rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/S_SAND.nc4", "S_SAND") |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
  rename( S_SAND = myvar ) |>
  tidyr::drop_na() |> 
  
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/S_CLAY.nc4", "S_CLAY") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( S_CLAY = myvar ),
    by = c("lon", "lat")
  ) |>
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/S_OC.nc4", "S_OC") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( S_OC = myvar ),
    by = c("lon", "lat")
  ) |>
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/S_GRAVEL.nc4", "S_GRAVEL") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( S_GRAVEL = myvar ),
    by = c("lon", "lat")
  ) |>

  ## get topsoil parameters
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/T_SAND.nc4", "T_SAND") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( T_SAND = myvar ),
    by = c("lon", "lat")
  ) |>
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/T_CLAY.nc4", "T_CLAY") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( T_CLAY = myvar ),
    by = c("lon", "lat")
  ) |>
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/T_OC.nc4", "T_OC") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( T_OC = myvar ),
    by = c("lon", "lat")
  ) |>
  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/T_GRAVEL.nc4", "T_GRAVEL") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( T_GRAVEL = myvar ),
    by = c("lon", "lat")
  ) |> 

  left_join(
    rbeni::nc_to_df("~/data/soil/hwsd/hwsd_wieder/data/ROOTS.nc4", "ROOTS") |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      rename( ROOTS = myvar ),
    by = c("lon", "lat")
  ) |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 

save(df_hwsd, file = "data/df_hwsd_hires.RData")

## something is going wrong
df_test <- nc_to_df(
  "~/data/soil/hwsd/hwsd_wieder/data/T_OC.nc4", "T_OC",  
  lon = (seq(7200) - 1) * 0.05 - 179.975,
  lat = (seq(3600) - 1) * 0.05 - 89.975
  )
  # mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3))
all_lon <- (seq(7200) - 1) * 0.05 - 179.975
all_lon[1:3] %in% (df_test$lon[1:3] |> unique())
all_lon[1:3]
(df_test$lon[1:3] |> unique())
```

Test plot.

```{r}
## load if it's not in the workspace yet
load("data/df_hwsd_hires.RData")

nc <- df_to_grid(df_hwsd, varnam = "T_SAND", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "T_SAND", lon = df_hwsd$lon |> unique() |> sort(), lat = df_hwsd$lat |> unique() |> sort(), path = "data/T_SAND.nc", make_zdim = FALSE)

system("cdo remapbil,gridfile_halfdeg.txt data/T_SAND.nc data/T_SAND_halfdeg.nc")

nc_halfdeg <- read_nc_onefile("data/T_SAND_halfdeg.nc", varnam = "T_SAND")
gg <- plot_map3(
  nc_halfdeg, 
  varnam = "T_SAND", 
  breaks = seq(0, 100, by = 10), 
  latmin = -60, latmax = 75,
  spacing = "constant",
  colorscale = viridis::magma,
  combine = FALSE
  )
gg$ggmap <- gg$ggmap + labs(title = "Sand fraction", subtitle = "Topsoil, percent")
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2))
ggsave("fig/map_T_SAND.pdf", width = 10, height = 6)
```

For global simulations, get soil parameters using the R script `rscript_calc_soilparams.R` (with `submit_calc_soilparams.sh`) and combine files with `rscript_combine_df_whc.R`.

#### Site-level

Extract point data from shapefile using `ingestr::ingest()`.

```{r}
if (siteset != "global"){
  ##----------------------------------------------
  ## Site-scale set
  ##----------------------------------------------
  ## Collect HWSD data from database
  filn <- paste0("data/df_hwsd_", siteset, ".RData")
  if (!file.exists(filn)){
    df_hwsd <- ingest(
      siteinfo,
      source = "hwsd",
      settings = list(fil = "~/data/hwsd/HWSD_RASTER/hwsd.bil")
      )
    save(df_hwsd, file = filn)
  } else {
    load(filn)
  }

  ## Calculate FC, PWP, and WHC from texture data.
  filn <- paste0("data/df_whc_", siteset, ".RData")
  if (!file.exists(filn)){
    df_whc <- df_hwsd |> 
      mutate(data = purrr::map(data, ~slice(., 1))) |> 
      mutate(
        data_soiltext_top = purrr::map(data, ~dplyr::select(
          ., fclay = T_CLAY, fgravel = T_GRAVEL, forg = T_OC, fsand = T_SAND, roots = ROOTS, imperm = IL)),
        data_soiltext_sub = purrr::map(data, ~dplyr::select(
          ., fclay = S_CLAY, fgravel = S_GRAVEL, forg = S_OC, fsand = S_SAND, roots = ROOTS, imperm = IL))
        ) |> 
      dplyr::select(-data) |> 
      mutate(data_soiltext_top = purrr::map(data_soiltext_top, ~calc_soilparams(., method = "balland")),
             data_soiltext_sub = purrr::map(data_soiltext_sub, ~calc_soilparams(., method = "balland")))

    save(df_whc, file = filn)
  } else {
    load(filn)
  }

}

## add to meta data table
siteinfo <- siteinfo |> 
  left_join(df_whc, by = "sitename")
```

For site-level simulations do:

```{r}
load("data/df_hwsd_hires.RData")

if (siteset!="global"){
 
df_whc <- df_hwsd |> 
  group_by(lon, lat) |> 
  nest() |> 
  mutate(
    data_soiltext_top = purrr::map(data, ~dplyr::select(
      ., fclay = T_CLAY, fgravel = T_GRAVEL, forg = T_OC, fsand = T_SAND, roots = ROOTS)),
    data_soiltext_sub = purrr::map(data, ~dplyr::select(
      ., fclay = S_CLAY, fgravel = S_GRAVEL, forg = S_OC, fsand = S_SAND, roots = ROOTS))
    ) |> 
  dplyr::select(-data) |> 
  mutate(data_soiltext_top = purrr::map(data_soiltext_top, ~calc_soilparams(., method = "balland")),
         data_soiltext_sub = purrr::map(data_soiltext_sub, ~calc_soilparams(., method = "balland")))
}
```

### WTD

-   Fan et al.

    -   Site scale: Hi-res Fan
    -   Global: Lo-res Fan

```{r}
if (siteset != "global"){
  ##----------------------------------------------
  ## Site-scale set
  ##----------------------------------------------
  ## Collect HWSD data from database
  filn <- paste0("data/df_wtd_fan_", siteset, ".RData")
  if (!file.exists(filn)){
    df_wtd <- siteinfo |> 
      dplyr::select(sitename, lon, lat) |> 
      ingest_wtd_fan()
    save(df_wtd, file = filn)
  } else {
    load(filn)
  }

}

## add to meta data table
siteinfo <- siteinfo |> 
  left_join(df_wtd |> 
              dplyr::select(sitename, wtd), 
            by = "sitename"
            )
```

### Biome

-   WWF, NSCP?

    -   Site scale: WWF, extract from shapefile
    -   Global: rasterize WWF data?

#### Global

Rasterize shapefile to high resolution global map.

```{r}
library(rgdal)

# read in the polygons
# shape <- readOGR("/alphadata01/bstocker/data/biomes/olson2001_teow/wwf_terr_ecos.shp")
shape <- readOGR("~/data/biomes/wwf_ecoregions/official/wwf_terr_ecos.shp")

# create empty raster
rasta <- raster(nrows=3600, ncols=7200, xmx=180, ymn=-90, ymx=90, crs=CRS("+init=EPSG:4326"))

# convert polygons to 1x1 raster
rasta_biome <- rasterize(shape, rasta, background=NA, field="BIOME")
#plot(rasta_biome)

# remove no data values
rasta_biome[rasta_biome %in% c(98, 99)] <- NA

# convert raster to factor
rasta_biome <- as.factor(rasta_biome)

# save to files
saveRDS( rasta_biome, "~/data/biomes/wwf_ecoregions/official/wwf_terr_ecos_raster.rds")

writeRaster( rasta_biome, "~/data/biomes/wwf_ecoregions/official/wwf_terr_ecos_raster.nc", 
             overwrite=TRUE, format="CDF", varname="biome", varunit="category", 
             longname="WWF ecoregions biome", xname="lon", yname="lat"
             )
```

#### Site-level

```{r}
if (siteset != "global"){
  ##----------------------------------------------
  ## Site-scale set
  ##----------------------------------------------
  ## WWF biome (Ecoregions dataset)
  filn <- paste0("data/df_biome_wwf_", siteset, ".RData")
  if (!file.exists(filn)){
    
    df_wwf <- ingest(
      dplyr::select(siteinfo, sitename, lon, lat),
      source = "wwf",
      dir = "~/data/biomes/wwf_ecoregions/official/",
      settings = list(layer = "wwf_terr_ecos")
      ) |> 
      mutate(data = purrr::map(data, ~slice(., 1)))
    
    save(df_wwf, file = filn)
  } else {
    load(filn)
  }
}

## add to meta data table
siteinfo <- siteinfo |> 
  left_join(df_wwf |> 
              mutate(data = purrr::map(data, ~dplyr::select(., biome_id = BIOME, biome_name = BIOME_NAME))) |>
              tidyr::unnest(data), 
            by = "sitename"
            )
```

### Save meta info

```{r}
filn <- paste0("data/siteinfo_", siteset, ".RData")
save(siteinfo, file = filn)

load(filn)
# filn <- paste0("data/siteinfo_", siteset, ".csv")
# siteinfo |> 
#   tidyr::unnest(c(data_soiltext_top, data_soiltext_sub)) |> 
#   write_csv(path = filn)
```

## Extract data

`rscript_get_data.R` Creates separate data frames for each data source, rows: site/gridcell, column: nested data, data: ET (W m-2), prec, snow, temp, elevation; large data! need to separate data frames by chunks for global analyses

### ALEXI

Test plot.

```{r}
library(sf)
library(raster)
library(rasterVis)
nc <- read_nc_onefile("~/data/alexi_tir/netcdf/EDAY_CERES_2006200.nc")

## crop and write smaller file
rasta <- raster("~/data/alexi_tir/netcdf/EDAY_CERES_2006200.nc")
lonmin <- 0
lonmax <- 180
latmin <- 50
latmax <- 80
rasta2 <- crop(rasta, extent(lonmin, lonmax, latmin, latmax))
raster::writeRaster(rasta2, filename = "./data/maptest.nc", format = "CDF", overwrite = TRUE )
plot_map3("./data/maptest.nc", lonmin = lonmin, lonmax = lonmax, latmin = latmin, latmax = latmax)
```

```{r}
if (siteset=="global"){
  
  ## run scripts `rscript_get_data_alexi.sh` and `rscript_get_data_alexi_lores.sh` on Euler by
  # system("./submit_get_data_alexi.sh")
  # system("./submit_get_data_alexi_lores.sh")
  
} else {
  ##------------------------------------------------------------------------
  ## Extract point data and construct single nested time series data frame
  ##------------------------------------------------------------------------
  filn <- paste0("data/df_alexi_", siteset,".Rdata")
  filn_csv <- str_replace(filn, "RData", "csv")
  if (!file.exists(filn)){
    if (!file.exists(filn_csv)){
      df_alexi <- get_data_mct_global(
        df_grid,
        dir_et   = "~/data/alexi_tir/netcdf/", fil_et_pattern = "EDAY_CERES_",
        get_watch = FALSE, get_landeval = FALSE, get_alexi = TRUE
      )
      save(df_alexi, file = filn)
      df_alexi |>
        tidyr::unnest(df) |>
        write_csv(path = filn_csv)
    } else {
      df_alexi <- read_csv(file = filn_csv) |>
        group_by(idx, lon, lat) |>
        tidyr::nest() |>
        dplyr::mutate(data = purrr::map(data, ~as_tibble(.))) |>
        dplyr::rename(df = data)
    }
  } else {
    load(filn)
    df_alexi |>
      tidyr::unnest(df) |>
      write_csv(path = filn_csv)
  } 
}
```

### WATCH

```{r}
##------------------------------------------------------------------------
## WATCH
##------------------------------------------------------------------------
filn <- paste0("data/df_watch_", siteset,".RData")
filn_csv <- str_replace(filn, "RData", "csv")
if (!file.exists(filn)){
  if (!file.exists(filn_csv)){
    df_watch <- get_data_mct_global(
      df_grid,
      dir_prec = "~/data/watch_wfdei/Rainf_daily/", fil_prec_pattern = "Rainf_daily_WFDEI_CRU",
      dir_snow = "~/data/watch_wfdei/Snowf_daily/", fil_snow_pattern = "Snowf_daily_WFDEI_CRU",
      dir_temp = "~/data/watch_wfdei/Tair_daily/",  fil_temp_pattern = "Tair_daily_WFDEI",
      get_watch = TRUE, get_landeval = FALSE, get_alexi = FALSE,
      year_start_watch = 2003, year_end_watch = 2018
    )
    save(df_watch, file = filn)
    df_watch |>
      tidyr::unnest(data) |>
      write_csv(path = filn_csv)
  } else {
    df_watch <- read_csv(file = filn_csv) |>
      group_by(sitename) |>
      tidyr::nest() |>
      dplyr::mutate(data = purrr::map(data, ~as_tibble(.))) |>
      dplyr::rename(df = data)
  }
} else {
  load(filn)
  df_watch |>
    tidyr::unnest(data) |>
    write_csv(path = filn_csv)
}
```

### SIF

`rscript_get_data_sif_jj.R` and `rscript_get_data_sif_pk.R`: Rearranging data from maps to time series data frames. Output is stored in `~/data/gome_2_sif_downscaled/data_tidy/`.

<!-- ```{r} -->

<!-- source("R/get_data_mct_global.R") # because this function is defined also in another source file - mess -->

<!-- ##------------------------------------------------------------------------ -->

<!-- ## SiF-downscaled from Duveiller -->

<!-- ##------------------------------------------------------------------------ -->

<!-- filn <- paste0("data/df_sif_", siteset, ".RData") -->

<!-- filn_csv <- str_replace(filn, "Rdata", "csv") -->

<!-- if (!file.exists(filn)){ -->

<!--   if (!file.exists(filn_csv)){ -->

<!--     ## version 'JJ'   -->

<!--     df_sif_jj <- get_data_mct_global( -->

<!--       df_grid, -->

<!--       dir_sif  = "~/data/gome_2_sif_downscaled/data_orig/", fil_sif_pattern = "GOME_JJ_dcSIF_005deg_8day_", -->

<!--       get_watch = FALSE, get_landeval = FALSE, get_alexi = FALSE, get_sif = TRUE -->

<!--     ) -->

<!--     df_sif_jj <- df_sif_jj |>  -->

<!--       rename(idx_uniquelonlat = idx) |>  -->

<!--       right_join(df_grid_allsiteid, -->

<!--                  by = c("lon", "lat")) -->

<!--     save(df_sif_jj, file = filn) -->

<!--     ## version 'PK'   -->

<!--     df_sif_pk <- get_data_mct_global( -->

<!--       df_grid, -->

<!--       dir_sif  = "~/data/gome_2_sif_downscaled/data_orig/", fil_sif_pattern = "GOME_PK_dcSIF_005deg_8day_", -->

<!--       get_watch = FALSE, get_landeval = FALSE, get_alexi = FALSE, get_sif = TRUE -->

<!--     ) -->

<!--     df_sif_pk <- df_sif_pk |>  -->

<!--       rename(idx_uniquelonlat = idx) |>  -->

<!--       right_join(df_grid_allsiteid, -->

<!--                  by = c("lon", "lat")) -->

<!--     save(df_sif_pk, file = filn)     -->

<!--     df_sif |> -->

<!--       tidyr::unnest(df) |> -->

<!--       write_csv(path = filn_csv) -->

<!--   } else { -->

<!--     df_sif <- read_csv(file = filn_csv) |> -->

<!--       group_by(idx, lon, lat) |> -->

<!--       tidyr::nest() |> -->

<!--       dplyr::mutate(data = purrr::map(data, ~as_tibble(.))) |> -->

<!--       dplyr::rename(df = data) -->

<!--   } -->

<!-- } else { -->

<!--   load(filn) -->

<!--   df_sif |> -->

<!--     tidyr::unnest(df) |> -->

<!--     write_csv(path = filn) -->

<!-- } -->

<!-- ``` -->

### GLASS net radiation

XXX TO BE COMPLETED

Test plot.

```{r}
library(sf)
library(raster)
library(rasterVis)
nc <- read_nc_onefile("~/data/alexi_tir/netcdf/EDAY_CERES_2006200.nc")

## crop and write smaller file
rasta <- raster("~/data/glass/data_netcdf/2001/GLASS07B01.V41.A2001166.2018264.nc")
lonmin <- 0
lonmax <- 180
latmin <- 50
latmax <- 80
rasta2 <- crop(rasta, extent(lonmin, lonmax, latmin, latmax))
raster::writeRaster(rasta2, filename = "./data/maptest.nc", format = "CDF", overwrite = TRUE )
plot_map3("./data/maptest.nc", lonmin = lonmin, lonmax = lonmax, latmin = latmin, latmax = latmax)
```

## Combine, convert units, complement, reduce

### Data filtering

Some ET data seem to be missing. Retain only sites with more than 3000 ET dates.

```{r}
n_avl_et <- function(df){
  sum(!is.na(df$et))
}

df_alexi <- df_alexi |> 
  mutate(avl_et = purrr::map_int(df, ~n_avl_et(.))) 

## where are they? They are along coasts. Ok, valid to remove them.
plot_map_simpl() +
  geom_point(
    data = df_alexi |> 
      dplyr::filter(avl_et < 3000),
    aes(lon, lat),
    color = 'red')

df_alexi <- df_alexi |> 
  dplyr::filter(avl_et > 3000)
```

Manipulates data frames prepared by step 2, reduced data frames with only 1 column: daily water balance (not cumulative!)

### ET in mm

#### Hires

-   Convert units to get ET in mm. Run scripts `submit_get_et_mm.sh` to run `rscript_get_et_mm.R`.

#### Lores

(Already provided in mm.) NO!!!

### Snow

#### Hires

Run script `rscript_simulate_snow.R` on Euler (submission file: `submit_simulate_snow.R`).

#### Lores

(Is the same as hires. Both at lores, in fact.)

### Daily water balance

#### Hires

Run script `rscript_get_bal.R` on Euler (submission file: `submit_get_bal.R`).

#### Lores

Using PET from SOFUN instead of ALEXI-ET.

Convert PET outputs to time series data frames.
```{r}
fileprefix <- "global_FULL_MODIS-C006_MOD15A2_v3.4.d.pet"
dir <- "~/data/sofun_outputs/global_FULL_MODIS-C006_MOD15A2_v3.4/"
nclist <- paste0(dir, list.files(dir, pattern = paste0(fileprefix, ".*.nc"), recursive = TRUE))

## create files for each longitude slice, containing full time series wrapped for each gridcell (latitude)
nclist_to_df(
  nclist, 
  outdir = "~/data/sofun_outputs/global_FULL_MODIS-C006_MOD15A2_v3.4/data_tidy/", 
  fileprefix = fileprefix, 
  varnam = "pet", 
  lonnam = "lon", 
  timenam = "time", 
  timedimnam = "time", 
  ncores = 1, 
  single_basedate = TRUE
  )
```

Get daily water balance components. Writes into `"~/mct/data/df_bal_lores/"`
```{r}
source("R/get_bal_byilon_lores.R")
df_out <- purrr::map(as.list(seq(720)), ~get_bal_byilon_lores(.))
```

### CWD events and extremes

Do both in one step. function `get_plantwhc_mct_bysite()` returns the CWD time series and events data frame (output from `mct()`), as well as the return periods data frame and the fitted model for the extreme value distribution

`mct2.R` Creates list with (i) water deficit time series, daily and cumulative, dday, iinst; and (ii) events data frame with maximum deficit, start date and length of event

-   Use parameters determined from FLUXNET-sites analysis (`thresh_terminate = 0.0, thresh_drop = 0.9`)

#### Hires

Run script `rscript_get_cwdx.R` on Euler (submission file: `submit_get_cwdx.R`).

#### Lores

```{r}
source("R/get_cwdx_byilon_lores.R")
df_out <- purrr::map(as.list(seq(720)), ~get_cwdx_byilon_lores(.))
```

## Check file availability

On Euler, run `rscript_check_files.R` and download the overview dataframe it writes (`data/df_file_availability.RData`)

```{r}
load("data/df_file_availability.RData")
```

Longitude slices for which now snow files are available -\> Possibly no WATCH-WFDEI gridcell at respective longitude? All available!

```{r}
df |> 
  dplyr::filter(!avl_snow)
```

Longitude slices without tidy ALEXI data. All available!

```{r}
df |> 
  dplyr::filter(!avl_tidy)
```

Longitude slices without ET-mm data (written by `R/get_et_mm_bylon.R`). All available.

```{r}
df |> 
  dplyr::filter(!avl_et_mm)
```

Longitude slices without `bal` data. All available.

```{r}
df |> 
  dplyr::filter(!avl_bal)
```

Longitude slices without CWDX data. All available.

```{r}
df |> 
  ungroup() |> 
  dplyr::filter(!avl_cwdx)
```

Longitude slices without extracted CWDX data. All available.

```{r}
df |> 
  dplyr::filter(!avl_cwdx_10_20_40 & avl_cwdx & avl_bal & avl_et_mm)
```

Total not available extracted CWDX data (longitude slices): 1,476

```{r}
df |> 
  ungroup() |> 
  dplyr::filter(!avl_cwdx_10_20_40)
```

## CWDX

### Hires

#### Extract

Extract CWD-extremes from full output.

Run `rscript_extract_cwdx.R` (with submit file `submit_extract_cwdx.sh`).

#### Collect data

For the global application, combine CWDX and soil texture information into a global common data frame. Run `rscript_collect_cwdx.R`

```{r}
## CWDX data
load("data/df_cwdx_10_20_40.RData") # loads 'df', created by rscript_collect_cwdx.R

df_cwdx <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 

rm("df")

## mask out non-land cells based on zroot (get info from soil data)
load("data/df_mask.RData")
df_cwdx <- df_cwdx |> 
  left_join(df_mask, by = c("lon", "lat"))
for (i in 3:8){
  df_cwdx[,i] <- df_cwdx[,i] * df_cwdx[,9]
}
```

#### Distribution of values

```{r}
df_cwdx |> 
  ggplot(aes(x = cwdx80, ..density..)) +
  geom_histogram() +
  xlim(0, 2500)

gt <- df_cwdx |> 
  filter(cwdx80 > 300) |> 
  pull(cwdx80) |> 
  length()

all <- df_cwdx |> 
  filter(!is.na(cwdx80)) |> 
  pull(cwdx80) |> 
  length()

gt/all
```

#### Write NetCDF

```{r}
## 10 y return period
nc <- df_to_grid(df_cwdx, varnam = "cwdx10", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwdx10", lon = df_cwdx$lon |> unique() |> sort(), lat = df_cwdx$lat |> unique() |> sort(), path = "data/cwdx10.nc", make_zdim = FALSE)

## 20 y return period
nc <- df_to_grid(df_cwdx, varnam = "cwdx20", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwdx20", lon = df_cwdx$lon |> unique() |> sort(), lat = df_cwdx$lat |> unique() |> sort(), path = "data/cwdx20.nc", make_zdim = FALSE)

## 40 y return period
nc <- df_to_grid(df_cwdx, varnam = "cwdx40", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwdx40", lon = df_cwdx$lon |> unique() |> sort(), lat = df_cwdx$lat |> unique() |> sort(), path = "data/cwdx40.nc", make_zdim = FALSE)

## 80 y return period
nc <- df_to_grid(df_cwdx, varnam = "cwdx80", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwdx80", lon = df_cwdx$lon |> unique() |> sort(), lat = df_cwdx$lat |> unique() |> sort(), path = "data/cwdx80.nc", make_zdim = FALSE)

## 100 y return period
nc <- df_to_grid(df_cwdx, varnam = "cwdx100", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwdx100", lon = df_cwdx$lon |> unique() |> sort(), lat = df_cwdx$lat |> unique() |> sort(), path = "data/cwdx100.nc", make_zdim = FALSE)

## 200 y return period
nc <- df_to_grid(df_cwdx, varnam = "cwdx200", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwdx200", lon = df_cwdx$lon |> unique() |> sort(), lat = df_cwdx$lat |> unique() |> sort(), path = "data/cwdx200.nc", make_zdim = FALSE)
```

Regrid to 0.25 deg

```{r}
system("cdo remapbil,gridfile_tenthdeg.txt data/cwdx10.nc data/cwdx10_tenthdeg.nc")
system("cdo remapbil,gridfile_tenthdeg.txt data/cwdx20.nc data/cwdx20_tenthdeg.nc")
system("cdo remapbil,gridfile_tenthdeg.txt data/cwdx40.nc data/cwdx40_tenthdeg.nc")
system("cdo remapbil,gridfile_tenthdeg.txt data/cwdx80.nc data/cwdx80_tenthdeg.nc")
system("cdo remapbil,gridfile_tenthdeg.txt data/cwdx100.nc data/cwdx100_tenthdeg.nc")
system("cdo remapbil,gridfile_tenthdeg.txt data/cwdx200.nc data/cwdx200_tenthdeg.nc")
```

### Lores

#### Extract

... and collect.
```{r}
source("R/extract_cwdx_byilon_lores.R")
out <- purrr::map_dfr(as.list(seq(720)), ~extract_cwdx_byilon_lores(.))
```

#### Write

### Maps

#### Global

Read tenth-degree global files and plot.

```{r}
load("data/df_vegmask_tenthdeg.RData")  # loads df_vegmask_tenthdeg

## 80 yr
nc_tenthdeg <- nc_to_df("data/cwdx80_tenthdeg.nc", varnam = "cwdx80") |> 
  mutate(lon = round(lon, digits = 2), lat = round(lat, digits = 2)) |>
  left_join(df_vegmask_tenthdeg |>
              mutate(lon = round(lon, digits = 2), lat = round(lat, digits = 2)),
            by = c("lon", "lat")) |>
  mutate(cwdx80 = ifelse(nonveg > 99, NA, cwdx80)) |> 
  mutate(cwdx80 = ifelse(lat > 74, NA, cwdx80))

gg <- plot_map4(nc_tenthdeg, 
                varnam = "cwdx80", 
                breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
                latmin = -60, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = FALSE, 
                colorscale = "batlowK", 
                legend_title = "(mm)",
                hillshade = FALSE,
                rivers = FALSE,
                ocean = TRUE,
                expand_size_y = 0.5,
                legend_direction = "vertical"
                )
gg$ggmap <- gg$ggmap + 
  labs(title = expression(paste(italic("S")[CWDX80])))

cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.12))
ggsave("fig/map_cwdx80.pdf", width = 10, height = 5)
ggsave("fig/map_cwdx80.png", width = 10, height = 5)

gg_fig3a <- gg$ggmap
gg_fig3a_legend <- gg$gglegend
```

#### Regional

Problem with missing data for certain gridcells. Solutions with varying `thresh_terminate` and with rounding digits of longitude and latitude values.

```{r}
# ## add rivers shapefile following https://www.earthdatascience.org/courses/earth-analytics/spatial-data-r/make-maps-with-ggplot-in-R/
# ## read rivers database
# rivers <- readOGR("~/data/world_rivers_dSe/world_rivers_dSe.shp")
# df_rivers <- tidy(rivers, region = "id")
# 
# # make sure the shapefile attribute table has an id column
# rivers$id <- rownames(rivers@data)
# 
# # join the attribute table from the spatial object to the new data frame
# df_rivers <- left_join(df_rivers,
#                        rivers@data,
#                        by = "id"
#                        )
# save(df_rivers, file = "data/df_rivers.RData")

load("data/df_cwdx_10_20_40.RData") # loads 'df', created by rscript_collect_cwdx.R

df_cwdx <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 

## apply vegetation mask
load("data/df_vegmask.RData") # loads df_vegmask
df_cwdx <- df_cwdx |>
  left_join(df_vegmask |> dplyr::select(lon, lat, vegmask),
            by = c("lon", "lat")) |>
  mutate(cwdx80 = cwdx80 * vegmask)

# ## spain
# gg <- df_cwdx |> 
#   dplyr::filter(lon > -10 & lon < 5 & lat > 35 & lat < 45) |> 
#   plot_map4(varnam = "cwdx80", lonmin = -10, lonmax = 5, latmin = 35, latmax = 45, 
#             breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
#             spacing = "constant",
#             colorscale = "batlowK")
# 
# ## italy
# gg <- df_cwdx |> 
#   dplyr::filter(lon > 7.5 & lon < 20 & lat > 36 & lat < 47) |> 
#   plot_map3(varnam = "cwdx80", lonmin = 7.5, lonmax = 20, latmin = 36, latmax = 47, breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), spacing = "constant")

## europe
gg <- df_cwdx |> 
  dplyr::filter(lon > -10 & lon < 25 & lat > 35 & lat < 55) |> 
  plot_map4(varnam = "cwdx80", 
            lonmin = -10, lonmax = 25, latmin = 35, latmax = 55, 
            breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
            spacing = "constant", 
            colorscale = "batlowK",
            combine = FALSE, legend_title = "(mm)",
            expand_size_y = 0.5,
            hillshade = TRUE, rivers = TRUE, lakes = TRUE,
            scale = 50
            )
gg$ggmap <- gg$ggmap + 
  labs(title = expression(italic(S)[CWDX80]))
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.1))
ggsave("fig/map_cwdx80_europe.pdf", width = 8, height = 6)
ggsave("fig/map_cwdx80_europe.png", width = 8, height = 6)

## western usa
gg <- df_cwdx |> 
  plot_map4(varnam = "cwdx80", 
            lonmin = -125, lonmax = -95, latmin = 32.5, latmax = 47, 
            breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
            spacing = "constant", 
            colorscale = "batlowK",
            combine = FALSE, legend_title = "(mm)",
            expand_size_y = 0.5,
            hillshade = TRUE, rivers = TRUE, lakes = TRUE,
            scale = 50
            )
gg$ggmap <- gg$ggmap + 
  labs(title = expression(italic(S)[CWDX80]))
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.1))
ggsave("fig/map_cwdx80_wusa.pdf", width = 10, height = 6)
ggsave("fig/map_cwdx80_wusa.png", width = 10, height = 6)

## central asia
gg <- df_cwdx |> 
  plot_map4(varnam = "cwdx80", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5, 
            breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
            spacing = "constant",
            combine = FALSE, 
            colorscale = "batlowK", legend_title = "(mm)",
            expand_size_y = 0.5,
            hillshade = TRUE, rivers = TRUE, lakes = TRUE,
            scale = 50
            )
gg$ggmap <- gg$ggmap + 
  labs(title = expression(italic(S)[CWDX80]))
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.1))
ggsave("fig/map_cwdx80_casia.pdf", width = 9, height = 5)
ggsave("fig/map_cwdx80_casia.png", width = 9, height = 5)

## Amazon
gg <- df_cwdx |> 
  drop_na(cwdx80) |> 
  plot_map4(varnam = "cwdx80", lonmin = -83, lonmax = -33, latmin = -25, latmax = 12, 
            breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
            spacing = "constant",
            combine = FALSE, 
            colorscale = "batlowK", legend_title = "(mm)",
            hillshade = TRUE, rivers = TRUE, lakes = TRUE, ocean = TRUE,
            expand_size_y = 0.6,
            scale = 50
            )
gg$ggmap <- gg$ggmap + 
  labs(title = expression(italic(S)[CWDX80])) 
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.1))
ggsave("fig/map_cwdx80_amazon.pdf", width = 9, height = 6)
ggsave("fig/map_cwdx80_amazon.png", width = 9, height = 6)
```
#### Distribution of CWDX

```{r}
load("data/df_cwdx_10_20_40.RData") # loads 'df', created by rscript_collect_cwdx.R
load("data/df_vegmask.RData") # loads df_vegmask
df_cwdx <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  left_join(df_vegmask |> dplyr::select(lon, lat, vegmask),
            by = c("lon", "lat")) |>
  mutate(cwdx80 = cwdx80 * vegmask)

gg_hist_cwdx80 <- df_cwdx |> 
  filter(cwdx80 < 1200) |> 
  ggplot(aes(x = cwdx80)) +
  # geom_density()
  geom_histogram(binwidth = 20) +
  xlim(0, 1200) +
  theme_classic() +
  labs(x = expression(italic(S)[CWDX80] ~ "(mm)"), y = "Count")
```

## WHC vs. CWDX

Plot for SI: Distribution of WHC in top 1 m soil. WHC is calculated based on HWSD data (https://daac.ornl.gov/SOILS/guides/HWSD.html). Described as "Topsoil refers to soil between 0 and 30 cm and subsoil to soil between 30 and 100 cm."
```{r}
load("data/df_whc.RData")

library(patchwork)

df_whc <- df_whc |> 
  mutate(whc_1m = 300 * whc_top + 700 * whc_sub) |> 
  mutate(whc_2m = 300 * whc_top + 700 * whc_sub + 1000 * whc_sub)

gg1 <- df_whc |> 
  ggplot(aes(x = whc_1m, y = ..density..)) + 
  geom_histogram() + 
  xlim(0, 250) +
  labs(x = "WHC (mm)", subtitle = "Top 1 m soil")


gg2 <- df_whc |> 
  ggplot(aes(x = whc_2m, y = ..density..)) + 
  geom_histogram() + 
  xlim(0, 400) +
  labs(x = "WHC (mm)", subtitle = "Top 2 m soil")

gg1 + gg2

ggsave("fig/whc_soil.pdf", width = 8, height = 4)
ggsave("fig/whc_soil.png", width = 8, height = 4)
```

Create NetCDF file with map of Extended Data Fig. 5.
```{r}
nc <- df_to_grid(df_whc, 
                 varnam = "whc_1m", 
                 lonnam = "lon", 
                 latnam = "lat"
                 )
write_nc2(nc, 
          varnams = "whc_1m", 
          lon = df_whc$lon |> unique() |> sort(), 
          lat = df_whc$lat |> unique() |> sort(), 
          path = "data/whc_1m.nc", 
          make_zdim = FALSE
          )

nc <- df_to_grid(df_whc, 
                 varnam = "whc_2m", 
                 lonnam = "lon", 
                 latnam = "lat"
                 )
write_nc2(nc, 
          varnams = "whc_2m", 
          lon = df_whc$lon |> unique() |> sort(), 
          lat = df_whc$lat |> unique() |> sort(), 
          path = "data/whc_2m.nc", 
          make_zdim = FALSE
          )
```

Regrid to 0.1 deg.
```{r}
# source("R/regrid_df.R")
# df_whc_agg <- regrid_df(df_whc, varnam = "whc_1m", dlon = 0.1, dlat = 0.1)

lon_breaks <- seq(from = floor(min(df_whc$lon)), to = ceiling(max(df_whc$lon)), by = 0.1)
lat_breaks <- seq(from = floor(min(df_whc$lat)), to = ceiling(max(df_whc$lat)), by = 0.1)

df_whc <- df_whc |>
  ungroup() |>
  mutate(ilon = cut(lon,
                    breaks = lon_breaks),
         ilat = cut(lat,
                    breaks = lat_breaks)) |>
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )) |>
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) |>
  
  ## create cell name to associate with climate input
  dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper)

df_whc_agg <- df_whc |> 
  group_by(lon_mid, lat_mid) |> 
  summarise(whc_1m = mean(whc_1m, na.rm = TRUE), whc_2m = mean(whc_2m, na.rm = TRUE)) |> 
  rename(lon = lon_mid, lat = lat_mid)
  # mutate(!!varnam := ifelse(is.nan(!!varnam), NA, !!varnam))

saveRDS(
  df_whc_agg,
  file = here::here("data/df_whc_agg.rds")
)
```

### Plot global WHC

```{r}
gg1 <- plot_map4(df_whc_agg, 
                varnam = "whc_1m", 
                breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
                latmin = -60, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = TRUE, 
                colorscale = "batlowK", 
                legend_title = "(mm)",
                expand_size_y = 0.5,
                ocean = TRUE)

# ggsave("fig/map_whc_1m.pdf", width = 10, height = 5)
# ggsave("fig/map_whc_1m.png", width = 10, height = 5)

gg2 <- plot_map4(df_whc_agg, 
                varnam = "whc_2m", 
                breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
                latmin = -60, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = TRUE, 
                colorscale = "batlowK", 
                legend_title = "(mm)",
                expand_size_y = 0.5,
                ocean = TRUE)

# ggsave("fig/map_whc_2m.pdf", width = 10, height = 5)
# ggsave("fig/map_whc_2m.png", width = 10, height = 5)

plot_grid(gg1, gg2, ncol = 1, labels = c('a', 'b'))
ggsave("fig/map_whc_1m_2m.pdf", width = 10, height = 9)
ggsave("fig/map_whc_1m_2m.png", width = 10, height = 9)
```

### Deep water access

```{r}
load("data/df_cwdx_10_20_40.RData") # loads 'df', created by rscript_collect_cwdx.R
df_cwdx <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 
rm("df")
load("data/df_vegmask.RData") # loads df_vegmask

df <- df_whc |> 
  dplyr::select(lon, lat, whc_1m, whc_2m) |> 
  left_join(
    df_cwdx,
    by = c("lon", "lat")
  ) |>
  left_join(df_vegmask |> 
              dplyr::select(lon, lat, nonveg),
            by = c("lon", "lat")) |> 
  mutate(area = rbeni::calc_area(lat, dx = 0.05, dy = 0.05)) |> 
  mutate(deeper_2m = ifelse(cwdx80 > whc_2m, 1, 0),
         deeper_1m = ifelse(cwdx80 > whc_1m, 1, 0)) |> 
  mutate(vegetated = ifelse(nonveg < 0.99, 1, 0))

## fraction of vegetated earth surface where plants have access to deep (>2 m) water
sum_deeper_1m <- df |> 
  mutate(tmp = area * vegetated * deeper_1m) |> 
  summarise(tmp = sum(tmp, na.rm = TRUE)) |> 
  pull(tmp)
sum_deeper_2m <- df |> 
  mutate(tmp = area * vegetated * deeper_2m) |> 
  summarise(tmp = sum(tmp, na.rm = TRUE)) |> 
  pull(tmp)
sum_vegetated <- df |> 
    mutate(tmp = area * vegetated) |> 
    summarise(tmp = sum(tmp, na.rm = TRUE)) |> 
    pull(tmp)
sum_deeper_1m / sum_vegetated
sum_deeper_2m / sum_vegetated
```

Plot where deeper
```{r}
df <- df |>
  ungroup() |>
  mutate(ilon = cut(lon,
                    breaks = lon_breaks),
         ilat = cut(lat,
                    breaks = lat_breaks)) |>
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )) |>
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) |>
  
  ## create cell name to associate with climate input
  dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper)

df_agg <- df |> 
  group_by(lon_mid, lat_mid) |> 
  summarise(deeper_1m = mean(deeper_1m, na.rm = TRUE), 
            deeper_2m = mean(deeper_2m, na.rm = TRUE)) |> 
  mutate(deeper_1m = ifelse(deeper_1m < 0.5, FALSE, TRUE), 
         deeper_2m = ifelse(deeper_2m < 0.5, FALSE, TRUE)) |> 
  rename(lon = lon_mid, lat = lat_mid)
```

```{r}
gg3 <- plot_map4(df_agg, 
                varnam = "deeper_1m", 
                # breaks = c(TRUE, FALSE), 
                latmin = -60, latmax = 80,
                # spacing = "constant", 
                # maxval = 6000, 
                # combine = TRUE, 
                # colorscale = viridis::cividis, 
                # legend_title = "",
                # expand_size_y = 0.5,
                ocean = TRUE,
                is_boolean = TRUE
                )

# ggsave("fig/map_whc_1m.pdf", width = 10, height = 5)
# ggsave("fig/map_whc_1m.png", width = 10, height = 5)

gg4 <- plot_map4(df_agg, 
                varnam = "deeper_2m", 
                # breaks = c(TRUE, FALSE), 
                latmin = -60, latmax = 80,
                # spacing = "constant", 
                # maxval = 6000, 
                # combine = TRUE, 
                # colorscale = viridis::cividis, 
                # legend_title = "",
                # expand_size_y = 0.5,
                ocean = TRUE,
                is_boolean = TRUE
                )

# ggsave("fig/map_whc_2m.pdf", width = 10, height = 5)
# ggsave("fig/map_whc_2m.png", width = 10, height = 5)

plot_grid(gg3$ggmap, gg4$ggmap, ncol = 1, labels = c('a', 'b'))
ggsave("fig/map_whc_1m_2m_deeper.png", width = 10, height = 9)
ggsave("fig/map_whc_1m_2m_deeper.pdf", width = 10, height = 9)
```

## Rooting depth

### Soil texture

This requires WHC data.

```{r}
## WHC, prepared by rscript_combine_df_whc.R, rscript_calc_soilparams.R, and code above writing "data/df_hwsd_hires.RData"
# load("data/df_whc_hires.RData")  # loads 'df_whc' - this has oddly missing values in south america
load("data/df_whc_hires_lasthope.RData")  # loads 'df_whc' - this one is complete

df_whc <- df_whc |> 
  dplyr::select(out) |> 
  unnest(out)
save(df_whc, file = "data/df_whc.RData")

## add biome info
df_biome <- nc_to_df("~/data/biomes/wwf_ecoregions/official/wwf_terr_ecos_raster.nc", varnam = "biome") |> 
  tidyr::drop_na(biome)

load("data/df_cwdx_10_20_80.RData") # loads 'df', as done already above, created by rscript_collect_cwdx.R

## merge
df <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  left_join(df_biome |> 
              mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)), 
            by = c("lon", "lat")) |> 
  left_join(df_whc |> 
              mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)), 
            by = c("lon", "lat"))

save(df, file = "data/df_mct_merged.RData")
```


Test plot: WHC in southern South America.

```{r}
gg <- df_whc |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  plot_map3(varnam = "whc_top", lonmin = -80, lonmax = -60, latmin = -60, latmax = -35, 
            breaks = c(seq(0, 0.4, by = 0.05), 0.8, Inf), 
            spacing = "constant",
            combine = FALSE, 
            colorscale = viridis::magma
            )
gg$ggmap <- gg$ggmap + labs(title = "WHC", subtitle = "Topsoil, fraction")
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2))
```

Regrid and plot WHC.

```{r}
## WHC
# nc <- df_to_grid(df, varnam = "whc_top", lonnam = "lon", latnam = "lat")
# write_nc2(nc, varnams = "whc_top", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/whc_top.nc", make_zdim = FALSE)
# system("cdo remapbil,gridfile_quartdeg.txt data/whc_top.nc data/whc_top_quartdeg.nc")

nc <- df_to_grid(df, varnam = "whc_sub", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "whc_sub", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/whc_sub.nc", make_zdim = FALSE)
system("cdo remapbil,gridfile_quartdeg.txt data/whc_sub.nc data/whc_sub_quartdeg.nc")

## FC
# nc <- df_to_grid(df, varnam = "fc_top", lonnam = "lon", latnam = "lat")
# write_nc2(nc, varnams = "fc_top", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/fc_top.nc", make_zdim = FALSE)
# system("cdo remapbil,gridfile_quartdeg.txt data/fc_top.nc data/fc_top_quartdeg.nc")

nc <- df_to_grid(df, varnam = "fc_sub", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "fc_sub", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/fc_sub.nc", make_zdim = FALSE)
system("cdo remapbil,gridfile_quartdeg.txt data/fc_sub.nc data/fc_sub_quartdeg.nc")

## PWP
# nc <- df_to_grid(df, varnam = "pwp_top", lonnam = "lon", latnam = "lat")
# write_nc2(nc, varnams = "pwp_top", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/pwp_top.nc", make_zdim = FALSE)
# system("cdo remapbil,gridfile_quartdeg.txt data/pwp_top.nc data/pwp_top_quartdeg.nc")

nc <- df_to_grid(df, varnam = "pwp_sub", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "pwp_sub", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/pwp_sub.nc", make_zdim = FALSE)
system("cdo remapbil,gridfile_quartdeg.txt data/pwp_sub.nc data/pwp_sub_quartdeg.nc")
```

```{r}
nc_quartdeg <- read_nc_onefile("data/whc_top_quartdeg.nc", varnam = "whc_top")
gg <- plot_map3(
  nc_quartdeg, 
  varnam = "whc_top", 
  breaks = c(seq(0, 0.4, by = 0.05), 0.8, Inf), 
  latmin = -60, latmax = 75,
  spacing = "constant",
  colorscale = viridis::magma,
  combine = FALSE
  )
gg$ggmap <- gg$ggmap + labs(title = "WHC", subtitle = "Topsoil, fraction")
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2))
ggsave("fig/map_whc_top.pdf", width = 10, height = 6)
ggsave("fig/map_whc_top.png", width = 10, height = 6)
```

### Global

Calculate implied rooting depth, given CWDX and WHC. WHC (`whc_top` and `whc_sub`) is derived from gridded HWSD data using `rscript_combine_df_whc.R`, `rscript_calc_soilparams.R`

```{r}
source("R/calc_zroot.R")
load("data/df_mct_merged.RData")

df <- df |> 
  rowwise() |> 
  dplyr::mutate(#zroot_cwd10 = calc_zroot(cwdx10, whc_top, whc_sub),
                #zroot_cwd20 = calc_zroot(cwdx20, whc_top, whc_sub),
                #zroot_cwd40 = calc_zroot(cwdx40, whc_top, whc_sub),
                zroot_cwd80 = calc_zroot(cwdx80, whc_top, whc_sub),
                #zroot_cwd100 = calc_zroot(cwdx100, whc_top, whc_sub),
                #zroot_cwd200 = calc_zroot(cwdx200, whc_top, whc_sub),
                ) |> 
 ungroup() |> 
 dplyr::select(lon, lat, biome, starts_with("zroot_"))

save(df, file = "data/df_zroot80.RData")

## save this as a mask
df_mask <- df |> 
  mutate(mask = ifelse(!is.na(zroot_cwd80), 1, NA)) |> 
  dplyr::select(lon, lat, mask)
save(df_mask, file = "data/df_mask.RData")
```

Distribution of rooting depth
```{r}
load("data/df_zroot80.RData")

df |> 
  ggplot(aes(zroot_cwd80/1000, ..density..)) + 
  geom_density() +
  xlim(0, 30)
```

Regrid and plot map.

```{r}
load("data/df_zroot80.RData")

nc <- df_to_grid(df, varnam = "zroot_cwd80", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "zroot_cwd80", lon = df$lon |> unique() |> sort(), lat = df$lat |> unique() |> sort(), path = "data/zroot_cwd80.nc", make_zdim = FALSE)

system("cdo remapbil,gridfile_quartdeg.txt data/zroot_cwd80.nc data/zroot_cwd80_quartdeg.nc")
system("cdo remapbil,gridfile_tenthdeg.txt data/zroot_cwd80.nc data/zroot_cwd80_tenthdeg.nc")
```

```{r}
load("data/df_vegmask_tenthdeg.RData")  # loads df_vegmask_tenthdeg

nc_tenthdeg <- nc_to_df("data/zroot_cwd80_tenthdeg.nc", varnam = "zroot_cwd80") |> 
  mutate(lon = round(lon, digits = 2), lat = round(lat, digits = 2)) |>
  left_join(df_vegmask_tenthdeg |>
              mutate(lon = round(lon, digits = 2), lat = round(lat, digits = 2)),
            by = c("lon", "lat")) |>
  mutate(zroot_cwd80 = ifelse(nonveg > 99, NA, zroot_cwd80)) |>
  mutate(zroot_cwd80 = ifelse(lat > 74, NA, zroot_cwd80)) |>
  mutate(zroot_cwd80 = zroot_cwd80 / 1000)

gg <- plot_map4(nc_tenthdeg, 
                varnam = "zroot_cwd80", 
                breaks = c(seq(0, 1, by = 0.2), 1.5, 2, 3, 5, 7, 10, 15, 20, 25, Inf), 
                latmin = -60, latmax = 80,
                spacing = "constant", 
                combine = FALSE, 
                colorscale = "lapaz", 
                legend_title = "(m)",
                hillshade = FALSE,
                rivers = FALSE,
                ocean = TRUE,
                expand_size_y = 0.5,
                legend_direction = "vertical")
gg$ggmap <- gg$ggmap + 
  labs(title = expression(paste(italic("z")[CWDX80])))

# cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.12))
# ggsave("fig/map_zroot_cwd80.png", width = 10, height = 5)
# ggsave("fig/map_zroot_cwd80.pdf", width = 10, height = 5)

gg_fig3b <- gg$ggmap
gg_fig3b_legend <- gg$gglegend
```

#### Distribution of values
```{r}
load("data/df_zroot80.RData") # loads df

gg_hist_zr <- df |> 
  # filter(zroot_cwd80 < 25000) |>
  ggplot(aes(x = zroot_cwd80/1000)) +
  # geom_density()
  geom_histogram(binwidth = 0.5) +
  xlim(0, 30) + ylim(0, 1e6) +
  theme_classic() +
  labs(x = expression(italic(z)[CWDX80] ~ "(m)"), y = "Count")
gg_hist_zr
```

### Site-level

See `mct_sj02_simsuite.Rmd`, creates data frame with z(CWDX) for different return periods

-   Use 20 year return period for good match of obs and mod at SJ02 sites (see ridges plot)
-   Use soil texture and WTD meta info prepared in step 1, see `mct_sj02_simsuite.Rmd`

```{r}
filn <- "data/df_zroot_sj02.RData"

if (!file.exists(filn)){

  ## use CWDXX for zroot, no root obstacles accounted for now
  df_zroot <- df_cwd |>
    ungroup() |> 
    dplyr::select(sitename = idx, out_mct) |> 
    left_join(
      df_whc |> 
        unnest(data_soiltext_sub) |>
        dplyr::select(sitename, whc_s = whc),
      by = "sitename"
    ) |> 
    left_join(
      df_whc |> 
        unnest(data_soiltext_top) |>
        dplyr::select(sitename, whc_t = whc, roots, imperm),
      by = "sitename"
    ) |> 
    # dplyr::select(sitename) |> 
    
    ## rooting depth from 20-year extreme
    dplyr::mutate(cwdx10 = purrr::map_dbl(out_mct, ~extract_return_level(., 10)),
                  cwdx20 = purrr::map_dbl(out_mct, ~extract_return_level(., 20)),
                  cwdx30 = purrr::map_dbl(out_mct, ~extract_return_level(., 30)),
                  cwdx40 = purrr::map_dbl(out_mct, ~extract_return_level(., 40))
                  ) |> 

    ## rooting depth from 10-year extreme
    rowwise() |> 
    dplyr::mutate(zroot_cwd10 = calc_zroot(cwdx10, whc_t, whc_s, roots, imperm),
                  zroot_cwd20 = calc_zroot(cwdx20, whc_t, whc_s, roots, imperm),
                  zroot_cwd30 = calc_zroot(cwdx30, whc_t, whc_s, roots, imperm),
                  zroot_cwd40 = calc_zroot(cwdx40, whc_t, whc_s, roots, imperm)
                  )

  save(df_zroot, file = filn)
  
} else {
  
  load(filn)
  
}
```

Use simulated zroot from earlier site-level simulation (`df_zroot`, loaded from `"data/df_zroot_sj02.RData"`), based on CWD extremes with 20-year return period.

```{r}
load("data/siteinfo_sj02.RData")

df_sj02 <- read_csv("~/data/rootingdepth/root_profiles_schenkjackson02/data/root_profiles_D50D95.csv") |> 
  dplyr::rename(lon = Longitude, lat = Latitude) |> 
  dplyr::filter(lon > -180 & lat > -90) |> 
  dplyr::filter(Wetland == "N" & Anthropogenic == "N" & Schenk_Jackson_2002 == "YES") |> 
  dplyr::rename(sitename = ID) |> 
  dplyr::mutate(D50 = 1000 * D50, D95 = 1000 * D95, D50_extrapolated = 1000 * D50_extrapolated, D95_extrapolated = 1000 * D95_extrapolated)

## extract values from global simulation
df_sj02 <- df_sj02 |>   
  left_join(
    extract_pointdata_allsites("data/zroot_cwd40.nc", df_sj02 |> dplyr::select(lon, lat), time = FALSE) |> 
      rename(zroot_cwdx40 = NA.),
    by = c("lon", "lat")
  ) |> 

  ## add biome info
  left_join(siteinfo |> 
              dplyr::select(sitename, biome_name = biome_name),
            by = "sitename")

save(df_sj02, file = paste0("data/df_sj02_biome_wwf_NEW.Rdata"))
```

<!-- Extract values from global simulation. Is practically the same as in old simulations! -->

<!-- From map (`"data/cwdx20.nc"`). -->

<!-- ```{r} -->

<!-- rasta_cwdx20 <- raster::brick("data/cwdx20.nc") -->

<!-- tmp <- raster::extract(rasta_cwdx20, sp::SpatialPoints(dplyr::select(df_modobs, lon, lat) |> distinct()), sp = TRUE) |> -->

<!--       as_tibble() |> -->

<!--       rename(cwdx20_global = layer) |>  -->

<!--       right_join( -->

<!--         df_modobs, -->

<!--         by = c("lon", "lat") -->

<!--       ) -->

<!-- ## close agreement! -->

<!-- tmp |>  -->

<!--   analyse_modobs2("cwdx20", "cwdx20_global") -->

<!-- rasta_zroot <- raster::brick("data/zroot_cwd20.nc") -->

<!-- df_modobs <- raster::extract(rasta_zroot, sp::SpatialPoints(dplyr::select(df_modobs, lon, lat) |> distinct()), sp = TRUE) |> -->

<!--   as_tibble() |> -->

<!--   rename(zroot_cwdx20_global = layer) |>  -->

<!--   right_join( -->

<!--     df_modobs, -->

<!--     by = c("lon", "lat") -->

<!--   ) -->

<!-- ## less close agreement - not using site-specific soil texture data! -->

<!-- df_modobs |>  -->

<!--   analyse_modobs2("zroot_cwdx20", "zroot_cwdx20_global") -->

<!-- ``` -->

Distribution by biomes, site-level data and site-level simulations. Tested also using global simulations and shows almost indistinguishable picture! Nice.

```{r}
library(ggridges)
#load("data/df_sj02_biome_wwf.Rdata")

df_sj02 |> 
  dplyr::select(sitename, biome_name, obs = D95_extrapolated, mod = zroot_cwdx40, lon, lat) |>  # change to mod = zroot_cwdx20_global
  tidyr::pivot_longer(cols = c(mod, obs), names_to = "source", values_to = "zroot") |> 
  dplyr::filter(!is.na(biome_name)) |> 
  dplyr::filter(biome_name!="Mangroves") |>   
  ggplot(aes(x = zroot / 1000, y = biome_name, color = source, point_color = source, fill = source)) +
  geom_density_ridges(
    jittered_points = TRUE, scale = .95, rel_min_height = .01,
    point_shape = "|", point_size = 1.5, size = 0.25,
    position = position_points_jitter(height = 0)
  ) +
  scale_y_discrete(expand = c(0, 0), name = "") +
  scale_x_continuous(expand = c(0, 0), name = "Rooting depth (m)") +
  scale_fill_manual(values = c("#D55E0050", "#0072B250"), labels = c(expression(italic(z)[CWDX40]), "Observed"), name = "") +
  scale_color_manual(values = c("#D55E00", "#0072B2"), guide = "none") +
  scale_discrete_manual("point_color", values = c("#D55E00", "#0072B2"), guide = "none") +
  coord_cartesian(clip = "off") +
  guides(fill = guide_legend(
    override.aes = list(
      fill = c("#D55E00A0", "#0072B2A0"),
      color = NA, point_color = NA)
    )
  ) +
  labs(title = expression("Rooting depth, SJ02 data")) +
  theme_ridges(center = TRUE)

ggsave("fig/modobs_ridges_zroot_biome_wwf_2022.pdf", width = 15, height = 10)
ggsave("fig/modobs_ridges_zroot_biome_wwf_2022.png", width = 15, height = 10)
```

Quantile regression plot.

```{r}
#load("data/df_sj02_biome_wwf_NEW.Rdata")

df_corr_biome <- df_sj02 |> 
  dplyr::filter(biome_name != "Mangroves") |> 
  group_by(biome_name) |> 
  summarise(q10_zroot_cwdx40 = quantile(zroot_cwdx40, probs = 0.10, na.rm = TRUE)/1000,
            q25_zroot_cwdx40 = quantile(zroot_cwdx40, probs = 0.25, na.rm = TRUE)/1000,
            q50_zroot_cwdx40 = quantile(zroot_cwdx40, probs = 0.50, na.rm = TRUE)/1000,
            q75_zroot_cwdx40 = quantile(zroot_cwdx40, probs = 0.75, na.rm = TRUE)/1000,
            q90_zroot_cwdx40 = quantile(zroot_cwdx40, probs = 0.90, na.rm = TRUE)/1000,
            
            q10_zroot_obs = quantile(D95_extrapolated, probs = 0.10, na.rm = TRUE)/1000,
            q25_zroot_obs = quantile(D95_extrapolated, probs = 0.25, na.rm = TRUE)/1000,
            q50_zroot_obs = quantile(D95_extrapolated, probs = 0.50, na.rm = TRUE)/1000,
            q75_zroot_obs = quantile(D95_extrapolated, probs = 0.75, na.rm = TRUE)/1000,
            q90_zroot_obs = quantile(D95_extrapolated, probs = 0.90, na.rm = TRUE)/1000
            )

out <- df_corr_biome |> 
  analyse_modobs2("q10_zroot_cwdx40", "q10_zroot_obs", label = FALSE, id = "biome_name", nlabels = 3)
gg_sj02_10 <- out$gg + labs(title = "10% quantile by biome, SJ02 data",
              x = expression(italic(z)[CWDX40] ~ " (m)"),
              y = expression("Observed" ~ italic(z)[root] ~ " (m)"))
gg_sj02_10
save(gg_sj02_10, file = "data/gg_sj02_10.RData")

out <- df_corr_biome |> 
  analyse_modobs2("q25_zroot_cwdx40", "q25_zroot_obs", label = FALSE, id = "biome_name", nlabels = 3)
gg_sj02_25 <- out$gg + labs(title = "25% quantile by biome, SJ02 data",
              x = expression(italic(z)[CWDX40] ~ " (m)"),
              y = expression("Observed" ~ italic(z)[root] ~ " (m)"))
gg_sj02_25
save(gg_sj02_25, file = "data/gg_sj02_25.RData")

out <- df_corr_biome |> 
  analyse_modobs2("q50_zroot_cwdx40", "q50_zroot_obs", label = FALSE, id = "biome_name", nlabels = 3)
gg_sj02_50 <- out$gg + labs(title = "50% quantile by biome, SJ02 data",
              x = expression(italic(z)[CWDX40] ~ " (m)"),
              y = expression("Observed" ~ italic(z)[root] ~ " (m)"))
gg_sj02_50
save(gg_sj02_50, file = "data/gg_sj02_50.RData")

out <- df_corr_biome |> 
  analyse_modobs2("q75_zroot_cwdx40", "q75_zroot_obs", label = FALSE, id = "biome_name", nlabels = 3)
gg_sj02_75 <- out$gg + labs(title = "75% quantile by biome, SJ02 data",
              x = expression(italic(z)[CWDX40] ~ " (m)"),
              y = expression("Observed" ~ italic(z)[root] ~ " (m)"))
gg_sj02_75
save(gg_sj02_75, file = "data/gg_sj02_75.RData")

out <- df_corr_biome |> 
  analyse_modobs2("q90_zroot_cwdx40", "q90_zroot_obs", label = FALSE, id = "biome_name", nlabels = 3)
gg_sj02_90 <- out$gg + labs(title = "90% quantile by biome, SJ02 data",
              x = expression(italic(z)[CWDX40] ~ " (m)"),
              y = expression("Observed" ~ italic(z)[root] ~ " (m)"))
gg_sj02_90
save(gg_sj02_90, file = "data/gg_sj02_90.RData")
```

Where are locations of points with largest mismatch?

```{r}
df_tmp <- df_modobs |> 
  mutate(error = zroot - D95_extrapolated) |> 
  arrange(desc(error)) |> 
  dplyr::select(sitename, zroot, D95_extrapolated, error, biome_wwf, lon, lat)

plot_map_simpl() +
  geom_point(data = df_tmp, 
             aes(lon, lat, color = error)) +
  scale_colour_gradient(low = "grey30", high = "red")
```

Are sites with largest mismatch characterised by a small reduction in flue (indicating groundwater access)?

```{r}
df_modobs |> 
  left_join(siteinfo |> 
              dplyr::select(sitename, biome_wwf = biome_name),
            by = "sitename") |> 
  mutate(error = zroot - D95_extrapolated) |> 
  arrange(desc(error)) |> 
  dplyr::select(sitename, zroot, D95_extrapolated, error, biome_wwf) |> 
  left_join(df_sif |> 
              dplyr::select(sitename = idx, flue, cwdmax),
            by = "sitename") |> 
  ggplot(aes(x = flue, y = error)) +
  geom_point()
```

### CWDX distribution

By biomes.

```{r}
df_sif |> 
  rename(sitename = idx) |> 
  left_join(siteinfo |> 
              dplyr::select(sitename, biome_wwf = biome_name),
            by = "sitename") |> 
  tidyr::pivot_longer(cols = c(cwdx20, cwd_lue0), names_to = "source", values_to = "cwd") |> 
  dplyr::filter(!is.na(biome_wwf)) |> 
  dplyr::filter(biome_wwf!="Mangroves") |> 

  ggplot(aes(x = cwd, y = biome_wwf, color = source, point_color = source, fill = source)) +
  geom_density_ridges(
    jittered_points = FALSE, scale = .95, rel_min_height = .01,
    point_shape = "|", point_size = 1.5, size = 0.25,
    position = position_points_jitter(height = 0)
  ) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), name = "rooting depth (mm)") +
  scale_fill_manual(values = c("#D55E0050", "#0072B250"), labels = c("CWD(LUE=0)", "CWDX")) +
  scale_color_manual(values = c("#D55E00", "#0072B2"), guide = "none") +
  scale_discrete_manual("point_color", values = c("#D55E00", "#0072B2"), guide = "none") +
  coord_cartesian(clip = "off") +
  guides(fill = guide_legend(
    override.aes = list(
      fill = c("#D55E00A0", "#0072B2A0"),
      color = NA, point_color = NA)
    )
  ) +
  ggtitle("Rooting depth by WWF biomes, SJ02 sites") +
  theme_ridges(center = TRUE)

ggsave(paste0("fig/modobs_ridges_cwd_biome_wwf_NEW", siteset, ".pdf"), width = 15, height = 10)
```

Something is wrong: Sites missing when applying new workflow. This is due to missing et_mm (elv was not ingested)

```{r}
load("data/df_modobs_reOLD.Rdata")
df_modobs_new <- dplyr::select(df_modobs, sitename, cwdx20, zroot)

df_test <- df_modobs_reOLD |>
  dplyr::select(zroot_old = zroot, cwdx20_old = cwd20) |>
  left_join(df_modobs_new, by = "sitename")

out <- df_test |>
  analyse_modobs2("zroot_old", "zroot")
out$gg

out <- df_test |>
  analyse_modobs2("cwdx20_old", "cwdx20")
out$gg
```

## SIF

Approach is to derive CWD(LUE=0) for estimating CWDX.

Run script `rscript_calc_cwd_lue0.R`, which wraps `calc_cwd_lue0_byilon()` and `calc_cwd_lue0()` (submission file: `submit_calc_cwd_lue0.sh`). Collects CWD data (including instances), SIF data, and WATCH-WFDEI SWdown data into one data frame per pixel and determines sensitivity (linear regression slope) of SIF vs. CWD and SIF/SW (nSIF) vs. CWD. Also determines fractional reduction in SIF and nSIF in highest CWD bin (using function `get_flue_cwdmax()`).

Then collect outputs using `rscript_collect_cwd_lue0.R` and read the file. It's huge.

```{r}
load("data/df_cwd_lue0_2.RData")
df_cwd_lue0 <- df
rm("df")
```

### Regional 

Regional hi-res plots.

```{r}
load("data/df_rivers.RData")
source("R/plot_map_cwdx_type_irrigation.R")

## Detect flattening
df_cwd_lue0 <- df_cwd_lue0 |>
  mutate(flat_nsif = ifelse(type_nSIF %in% c("Aa", "A1", "A2a"), TRUE, NA))

df_irr <- nc_to_df("~/data/irrigation/gmia_v5_aai_pct_0_05deg.nc", varnam = "aai") |> 
      drop_na() |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      rename(irr = aai)

## central asia SIF
gg <- df_cwd_lue0 |>
  plot_map4(varnam = "cwd_lue0_nSIF", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5,
            breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf),
            spacing = "constant",
            combine = FALSE,
            colorscale = "batlowK",
            legend_title = "(mm)",
            hillshade = TRUE,
            rivers = TRUE,
            scale = 50
            )
gg$ggmap <- gg$ggmap +
  labs(title = expression(paste(italic("S")[dEF])))
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2))
ggsave("fig/map_cwd_lue0_fet0_casia2.pdf", width = 10, height = 6)


# ## central asia S0-Teuling
# gg <- df_cwd_lue0 |> 
#   plot_map4(varnam = "s0_teuling_fet", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5, 
#             breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
#             spacing = "constant",
#             combine = FALSE, 
#             colorscale = "batlowK"
#             )
# gg$ggmap <- gg$ggmap + 
#   labs(title = expression(paste(italic("S")[0-Teuling]))) +
#   geom_path(data = df_rivers, aes(x = long, y = lat, group = group), color = "dodgerblue")
# cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2))
# ggsave("fig/map_s0_teuling_fet_casia2.pdf", width = 10, height = 6)
# ggsave("fig/map_s0_teuling_fet_casia2.png", width = 10, height = 6)

## Western USA, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_lue0, df_irr,
  name_cwdx = "cwd_lue0_nSIF", name_type = "flat_nsif", name_irr = "irr",
  lonmin = -125, lonmax = -95, latmin = 32.5, latmax = 47, 
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = expression(paste(italic("S")[dEF], " (mm)")), 
  hillshade = TRUE,
  rivers = TRUE,
  scale = "medium",
  expand_size_y = 0.4,
  irr_cutoff = 0.3
  )
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
ggsave("fig/map_cwd_lue0_types_lue0_wusa.pdf", width = 10, height = 6)
ggsave("fig/map_cwd_lue0_types_lue0_wusa.png", width = 10, height = 6)


## Amazon, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_lue0, df_irr,
  name_cwdx = "cwd_lue0_nSIF", name_type = "flat_nsif", name_irr = "irr",
  lonmin = -83, lonmax = -33, latmin = -25, latmax = 12,
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = expression(paste(italic("S")[dEF], " (mm)")), 
  hillshade = TRUE,
  rivers = TRUE,
  scale = 50,
  expand_size_y = 0.4,
  irr_cutoff = 0.3
  )
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
ggsave("fig/map_cwd_lue0_types_lue0_amazon.pdf", width = 9, height = 6)
ggsave("fig/map_cwd_lue0_types_lue0_amazon.png", width = 9, height = 6)


## Europe, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_lue0, df_irr,
  name_cwdx = "cwd_lue0_nSIF", name_type = "flat_nsif", name_irr = "irr",
  lonmin = -10, lonmax = 25, latmin = 35, latmax = 55, 
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = expression(paste(italic("S")[dEF], " (mm)")), 
  hillshade = TRUE,
  rivers = TRUE,
  scale = 50,
  expand_size_y = 0.4,
  irr_cutoff = 0.3,
  legend_title = "(mm)"
  )
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
ggsave("fig/map_cwd_lue0_types_lue0_europe.pdf", width = 8, height = 6)
ggsave("fig/map_cwd_lue0_types_lue0_europe.png", width = 8, height = 6)
```



### Global

<!-- Convert to nc object and write to file. -->

<!-- ```{r} -->
<!-- ## SIF -->
<!-- nc <- df_to_grid(df_cwd_lue0, varnam = "cwd_lue0_SIF", lonnam = "lon", latnam = "lat") -->
<!-- write_nc2(nc, varnams = "cwd_lue0_SIF", lon = df_cwd_lue0$lon |> unique() |> sort() |> round(digits = 3), lat = df_cwd_lue0$lat |> unique() |> sort() |> round(digits = 3), path = "data/cwd_lue0_SIF.nc", make_zdim = FALSE) -->

<!-- # ## aggregate using raster -->
<!-- # rasta <- raster(nc,  -->
<!-- #                 xmn = min(round(sort(unique(df_cwd_lue0$lon)), digits = 3)) - 0.05, -->
<!-- #                 xmx = max(round(sort(unique(df_cwd_lue0$lon)), digits = 3)) + 0.05, -->
<!-- #                 ymn = min(round(sort(unique(df_cwd_lue0$lat)), digits = 3)) - 0.05, -->
<!-- #                 ymx = max(round(sort(unique(df_cwd_lue0$lat)), digits = 3)) + 0.05 -->
<!-- #                 ) -->
<!-- # rasta_agg <- aggregate(rasta, fact=2, fun=mean, expand=TRUE, na.rm=TRUE) -->
<!-- # writeRaster( rasta_agg, "data/cwd_lue0_SIF_tenthdeg_raster.nc",  -->
<!-- #              overwrite=TRUE, format="CDF", varname="cwd_lue0_SIF", varunit="mm",  -->
<!-- #              longname="S_dSIF", xname="lon", yname="lat" -->
<!-- #              ) -->

<!-- ## nSIF -->
<!-- nc <- df_to_grid(df_cwd_lue0, varnam = "cwd_lue0_nSIF", lonnam = "lon", latnam = "lat") -->
<!-- write_nc2(nc, varnams = "cwd_lue0_nSIF", lon = df_cwd_lue0$lon |> unique() |> sort() |> round(digits = 3), lat = df_cwd_lue0$lat |> unique() |> sort() |> round(digits = 3), path = "data/cwd_lue0_nSIF.nc", make_zdim = FALSE) -->

<!-- # ## aggregate using raster -->
<!-- # rasta <- raster(nc,  -->
<!-- #                 xmn = min(round(sort(unique(df_cwd_lue0$lon)), digits = 3)) - 0.05, -->
<!-- #                 xmx = max(round(sort(unique(df_cwd_lue0$lon)), digits = 3)) + 0.05, -->
<!-- #                 ymn = min(round(sort(unique(df_cwd_lue0$lat)), digits = 3)) - 0.05, -->
<!-- #                 ymx = max(round(sort(unique(df_cwd_lue0$lat)), digits = 3)) + 0.05 -->
<!-- #                 ) -->
<!-- # rasta_agg <- aggregate(rasta, fact=2, fun=mean, expand=TRUE, na.rm=TRUE) -->
<!-- # writeRaster( rasta_agg, "data/cwd_lue0_nSIF_tenthdeg_raster.nc",  -->
<!-- #              overwrite=TRUE, format="CDF", varname="cwd_lue0_nSIF", varunit="mm",  -->
<!-- #              longname="S_dnSIF", xname="lon", yname="lat" -->
<!-- #              ) -->

<!-- # ## lambda_decay_SIF -->
<!-- # nc <- df_to_grid(df_cwd_lue0_SIF, varnam = "lambda_decay_SIF", lonnam = "lon", latnam = "lat") -->
<!-- # write_nc2(nc, varnams = "lambda_decay_SIF", lon = df_cwd_lue0_SIF$lon |> unique() |> sort(), lat = df_cwd_lue0_SIF$lat |> unique() |> sort(), path = "data/lambda_decay_SIF.nc", make_zdim = FALSE) -->
<!-- #  -->
<!-- # ## lambda_decay_nSIF -->
<!-- # nc <- df_to_grid(df_cwd_lue0_nSIF, varnam = "lambda_decay_nSIF", lonnam = "lon", latnam = "lat") -->
<!-- # write_nc2(nc, varnams = "lambda_decay_nSIF", lon = df_cwd_lue0_nSIF$lon |> unique() |> sort(), lat = df_cwd_lue0_nSIF$lat |> unique() |> sort(), path = "data/lambda_decay_nSIF.nc", make_zdim = FALSE) -->
<!-- ``` -->

Regrid to 0.1 deg.

```{r}
## add vegetation mask (fraction of non-vegetated)
# load("data/df_vegmask.RData") # loads df_vegmask
df_cwd_lue0 <- df_cwd_lue0 |>
  left_join(df_vegmask |> dplyr::select(lon, lat, nonveg),
            by = c("lon", "lat"))

## bin to half-degree gridcells for determining climate forcing
dlon <- 0.1
dlat <- 0.1
lon_breaks <- seq(from = floor(min(df_cwd_lue0$lon)), to = ceiling(max(df_cwd_lue0$lon)), by = dlon)
lat_breaks <- seq(from = floor(min(df_cwd_lue0$lat)), to = ceiling(max(df_cwd_lue0$lat)), by = dlat)

df_cwd_lue0 <- df_cwd_lue0 |>
  ungroup() |>
  mutate(ilon = cut(lon,
                    breaks = lon_breaks
                    ),
         ilat = cut(lat,
                    breaks = lat_breaks
                    )
         ) |>
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )
         ) |>
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) |>

  ## create cell name to associate with climate input
  dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper)

df_cwd_lue0_agg <- df_cwd_lue0 |> 
  group_by(lon_mid, lat_mid) |> 
  summarise(cwd_lue0_SIF = mean(cwd_lue0_SIF, na.rm = TRUE), 
            cwd_lue0_nSIF = mean(cwd_lue0_nSIF, na.rm = TRUE),
            nonveg = mean(nonveg, na.rm = TRUE)) |> 
  rename(lon = lon_mid, lat = lat_mid) |> 
  mutate(cwd_lue0_SIF = ifelse(is.nan(cwd_lue0_SIF), NA, cwd_lue0_SIF),
         cwd_lue0_nSIF = ifelse(is.nan(cwd_lue0_nSIF), NA, cwd_lue0_nSIF))

save(df_cwd_lue0_agg, file = "data/df_cwd_lue0_agg.Rdata")
```


Read tenth-degree global file and plot.
```{r}
load("data/df_cwd_lue0_agg.Rdata")

# apply vegetation mask
df_cwd_lue0_agg <- df_cwd_lue0_agg |> 
  # mutate(cwd_lue0_nSIF = ifelse(nonveg > 0.99, NA, cwd_lue0_nSIF)) |> 
  mutate(cwd_lue0_nSIF = ifelse(lat > 74, NA, cwd_lue0_nSIF))  # values higher north are implausible

## nSIF
# nc_tenthdeg <- read_nc_onefile("data/cwd_lue0_nSIF_tenthdeg.nc", varnam = "cwd_lue0_nSIF")
gg <- plot_map4(df_cwd_lue0_agg, 
                varnam = "cwd_lue0_nSIF", 
                breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
                latmin = -60, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = FALSE, 
                colorscale = "batlowK", 
                legend_title = "(mm)",
                legend_direction = "horizontal",
                ocean = TRUE
                )
gg$ggmap <- gg$ggmap + 
  labs(title = expression(paste(italic("S")[dSIF])))
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 1, rel_heights = c(1, 0.2))
ggsave("fig/map_cwd_lue0_nSIF.pdf", width = 10, height = 6)
ggsave("fig/map_cwd_lue0_nSIF.png", width = 10, height = 6)

gg_fig1b <- gg$ggmap
gg_fig1_legend <- gg$gglegend
save(gg_fig1b, file = "data/gg_fig1b.Rdata")

# ## lambda_decay_SIF
# nc_tenthdeg <- read_nc_onefile("data/lambda_decay_SIF_tenthdeg.nc", varnam = "lambda_decay_SIF")
# plot_map3(nc_tenthdeg, varnam = "lambda_decay_SIF", breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), latmin = -60, latmax = 80,
#           spacing = "constant", maxval = 6000)
# ggsave("fig/map_lambda_decay_SIF.pdf", width = 10, height = 6)
# 
# ## lambda_decay_nSIF
# nc_tenthdeg <- read_nc_onefile("data/lambda_decay_nSIF_tenthdeg.nc", varnam = "lambda_decay_nSIF")
# plot_map3(nc_tenthdeg, varnam = "lambda_decay_nSIF", breaks = -(c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf)), latmin = -60, latmax = 80,
#           spacing = "constant", maxval = 6000)
# ggsave("fig/map_lambda_decay_nSIF.pdf", width = 10, height = 6)
```

### Find missing SIF data. 

`cwd_lue0_nSIF` is entirely missing in the data frame for respective longitudes.

```{r}
## all longitudes
lon_all <- seq(from = -179.975, to = 179.975, by = 0.05) |> 
  round(digits = 3)

## available lons
lon_avl <- df_cwd_lue0 |> 
  filter(!is.na(cwd_lue0_nSIF)) |> 
  pull(lon) |> 
  unique() |> 
  round(digits = 3)

## missing lons
lon_missing <- lon_all[!(lon_all %in% lon_avl)]
ilon_missing <- (lon_missing + 179.975)/0.05 + 1

saveRDS(ilon_missing, file = "data/ilon_missing.rds")

## relevant: 3961-4176 and 2161-2232

plot(lon_all, !(lon_all %in% lon_avl), type = "l")
plot(!(lon_all %in% lon_avl), type = "l")
```

<!-- ### Correlation with CWDX -->

<!-- Plot correlation at global scale. -->

<!-- #### High resolution. -->

<!-- ```{r} -->

<!-- df_corr_sif_hires <- df_cwdx |>  -->

<!--   left_join( -->

<!--     df_cwd_lue0 |>  -->

<!--       dplyr::select(lon, lat, cwd_lue0_SIF, cwd_lue0_nSIF), -->

<!--     by = c("lon", "lat") -->

<!--   ) -->

<!-- out <- df_corr_sif_hires |>  -->

<!--   mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF, coef = 10)) |>  -->

<!--   analyse_modobs2("cwdx20", "cwd_lue0_SIF", type = "hex", plot_linmod = FALSE) -->

<!-- out$gg + -->

<!--   scale_x_continuous(expand = c(0,0), limits = c(0,500)) +  -->

<!--   scale_y_continuous(expand = c(0,0), limits = c(0,500)) -->

<!-- out <- df_corr_sif_hires |>  -->

<!--   mutate(cwd_lue0_nSIF = remove_outliers(cwd_lue0_nSIF, coef = 10)) |>  -->

<!--   analyse_modobs2("cwdx20", "cwd_lue0_nSIF", type = "hex", plot_linmod = FALSE) -->

<!-- out$gg + -->

<!--   scale_x_continuous(expand = c(0,0), limits = c(0,500)) +  -->

<!--   scale_y_continuous(expand = c(0,0), limits = c(0,500)) -->

<!-- ``` -->

<!-- ### fLUE reduction -->

<!-- Relative reduction (fraction of pre-drought level) in vegetation activity (\~SIF, \~EF) in the highest CWD bin. -->

<!-- ```{r} -->

<!-- load("data/df_flue_SIF.RData") -->

<!-- load("data/df_rivers.RData") -->

<!-- ## central asia -->

<!-- gg <- df_flue_SIF |>  -->

<!--   plot_map3(varnam = "flue_SIF", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5,  -->

<!--             breaks = seq(0, 1, by = 0.1), -->

<!--             spacing = "constant", -->

<!--             combine = FALSE, -->

<!--             colorscale = "batlowK" -->

<!--             ) -->

<!-- gg$ggmap <- gg$ggmap +  -->

<!--   labs(title = "fLUE at maximum CWD") + -->

<!--   geom_path(data = df_rivers, aes(x = long, y = lat, group = group), color = "dodgerblue") -->

<!-- cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2)) -->

<!-- ggsave("fig/map_flue_SIF_casia.pdf", width = 9, height = 5) -->

<!-- ggsave("fig/map_flue_SIF_casia.png", width = 9, height = 5) -->

<!-- ``` -->

<!-- ### Clusters -->

<!-- ```{r} -->

<!-- load("data/df_df_flue_SIF.RData") -->

<!-- load("data/df_cwd_lue0_SIF.RData") -->

<!-- df_cluster_SIF <- df_df_flue_SIF |>  -->

<!--   left_join(c, by = c("lon", "lat")) |>  -->

<!--   drop_na(cwd_lue0_SIF) |>  -->

<!--   # slice_sample(prop = 0.01) |>  -->

<!--   dplyr::select(-cwd_lue0_SIF) |>  -->

<!--   mutate(n_row = map_int(df_flue_SIF, ~nrow(.))) |>  -->

<!--   dplyr::filter(n_row == 5) |>  -->

<!--   mutate(df_flue_SIF = purrr::map(df_flue_SIF, ~mutate(., bin = paste0("b", seq(5))))) |>  -->

<!--   dplyr::select(lon, lat, df_flue_SIF) |>  -->

<!--   unnest(df_flue_SIF) |>  -->

<!--   pivot_wider(names_from = bin, values_from = flue) |>  -->

<!--   drop_na() -->

<!-- save(df_cluster_SIF, file = "data/df_cluster_SIF.RData") -->

<!-- # ## not clear how many is optimal -->

<!-- # out_kmeans <- map(as.list(2:10), ~kmeans(dplyr::select(df_cluster_SIF, starts_with("b")), centers = .)) -->

<!-- # out_kmeans |>  -->

<!-- #   map("withinss") |>  -->

<!-- #   map_dbl(~sum(.)) |>  -->

<!-- #   tibble(n_clusters = 2:10, sum_within_ss = .) |>  -->

<!-- #   ggplot(aes(x = n_clusters, y = sum_within_ss)) + -->

<!-- #   geom_point() -->

<!-- # ggsave("fig/clusters_SIF_sumwithinss.pdf", width = 6, height = 4) -->

<!-- ## prescribed number of clusters -->

<!-- set.seed(1982) -->

<!-- out <- kmeans(dplyr::select(df_cluster_SIF, starts_with("b")), centers = 2) -->

<!-- df_cluster_SIF$cluster_2 <- out$cluster -->

<!-- save(df_cluster_SIF, file = "data/df_cluster_SIF.RData") -->

<!-- out$centers |>  -->

<!--   as_tibble() |> -->

<!--   mutate(cluster = paste0("c", 1:n())) |>  -->

<!--   pivot_longer(cols = starts_with("b"), names_to = "bin", values_to = "flue", names_prefix = "b") |>  -->

<!--   ggplot(aes(x = bin, y = flue, color = cluster)) + -->

<!--   geom_point(size = 2) + -->

<!--   geom_line() + -->

<!--   ylim(0.4,1) -->

<!-- ggsave("fig/clusters_SIF.pdf", width = 6, height = 4) -->

<!-- ``` -->

<!-- Plot cluster. -->

<!-- ```{r} -->

<!-- ## central asia -->

<!-- gg <- df_cluster_SIF |> -->
<!--   plot_map3(varnam = "cluster_2", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5, -->
<!--             breaks = 0:2, -->
<!--             spacing = "constant", -->
<!--             combine = FALSE, -->
<!--             colorscale = wesanderson::wes_palette(n=2, name="Darjeeling1") -->
<!--             ) -->

<!-- gg$ggmap <- gg$ggmap +  -->

<!--   labs(title = "Cluster") + -->

<!--   geom_path(data = df_rivers, aes(x = long, y = lat, group = group), color = "dodgerblue") -->

<!-- cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2)) -->

<!-- ggsave("fig/map_clusters_casia.pdf", width = 15, height = 10) -->

<!-- ## western usa -->

<!-- gg <- df_cluster_SIF |>  -->

<!--   plot_map3(varnam = "cluster_3",  -->

<!--             lonmin = -125, lonmax = -90, latmin = 32.5, latmax = 47,  -->

<!--             breaks = 0:3, -->

<!--             spacing = "constant",  -->

<!--             colorscale = wesanderson::wes_palette(n=3, name="Darjeeling1"), -->

<!--             combine = FALSE -->

<!--             ) -->

<!-- gg$ggmap <- gg$ggmap +  -->

<!--   labs(title = "Cluster") + -->

<!--   geom_path(data = df_rivers, aes(x = long, y = lat, group = group), color = "dodgerblue") -->

<!-- cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2)) -->

<!-- ggsave("fig/map_clusters_wusa.pdf", width = 20, height = 10) -->

<!-- ``` -->

<!-- ### Site-level -->

<!-- Script used for testing at FLUXNET sites: `test_mct_bysite_alexi_fluxnet.R` -->

<!-- -   Use CWD events from step 3 and SiF from step 2 -->

<!-- Add SiF data to -->

<!-- ```{r} -->

<!-- source("R/get_flue_cwdmax.R") -->

<!-- load("data/df_sif_jj_sj02.Rdata") -->

<!-- load("data/df_sif_pk_sj02.Rdata") -->

<!-- filn <- paste0("data/df_sif_lue0", siteset, ".Rdata") -->

<!-- if (!file.exists(filn)){ -->

<!--   add_mean_sif <- function(df){ -->

<!--     rowMeans( cbind(df$sif_jj, df$sif_pk) ) -->

<!--   } -->

<!--   df_sif <- df_cwd |>  -->

<!--     dplyr::select(-data) |>  -->

<!--     mutate(cwdx40 = purrr::map_dbl(out_mct, ~extract_return_level(., 40))) |>  -->

<!--     mutate(mct = purrr::map(out_mct, "mct")) |>  -->

<!--     ungroup() |>  -->

<!--     dplyr::select(idx, mct, cwdx40) |>  -->

<!--     mutate(df = purrr::map(mct, "df"), -->

<!--            inst = purrr::map(mct, "inst")) |>  -->

<!--     dplyr::select(-mct) |>  -->

<!--     ## add sif data -->

<!--     left_join( -->

<!--       df_sif_jj |> dplyr::select(idx, df_jj = data), -->

<!--       by = "idx" -->

<!--     ) |>  -->

<!--     left_join( -->

<!--       df_sif_pk |> dplyr::select(idx, df_pk = data), -->

<!--       by = "idx" -->

<!--     ) |>  -->

<!--     dplyr::filter(!is.null(df) & !is.null(df_jj) & !is.null(df_pk) & !is.na(cwdx40)) |>  -->

<!--     mutate(df = purrr::map2(df, df_jj, ~left_join(.x, .y, by = "date"))) |>  -->

<!--     mutate(df = purrr::map(df, ~rename(., sif_jj = sif))) |>  -->

<!--     mutate(df = purrr::map2(df, df_pk, ~left_join(.x, .y, by = "date"))) |>  -->

<!--     mutate(df = purrr::map(df, ~rename(., sif_pk = sif))) |>  -->

<!--     # mutate(df = purrr::map(df, ~add_mean_sif(.))) |>  -->

<!--     mutate(df = purrr::map(df, ~rename(., lue = sif_jj))) |> -->

<!--     ## get CWD at LUE0=0 -->

<!--     mutate(out_lue0 = purrr::map2(df, inst, ~calc_cwd_lue0(.x, .y, do_plot = TRUE))) |>  -->

<!--     mutate(cwd_lue0 = purrr::map_dbl(out_lue0, "lue0")) |>  -->

<!--     mutate(cwd_lue0_exp = purrr::map_dbl(out_lue0, "lue0_exp")) |>  -->

<!--     mutate(gg = purrr::map(out_lue0, "gg")) |>  -->

<!--     ## get fLUE at CWDmax -->

<!--     mutate(out_flue = purrr::map(df, ~get_flue_cwdmax(.))) |>  -->

<!--     mutate(flue = purrr::map_dbl(out_flue, "flue")) |>  -->

<!--     mutate(cwdmax = purrr::map_dbl(out_flue, "cwdmax")) |>  -->

<!--     dplyr::select(idx, cwdx40, cwd_lue0, cwd_lue0_exp, gg, flue, cwdmax) -->

<!--   save(df_sif, file = filn) -->

<!-- } else { -->

<!--   load(filn) -->

<!-- } -->

<!-- df_sif |>  -->

<!--   mutate(cwd_lue0 = remove_outliers(cwd_lue0)) |>  -->

<!--   analyse_modobs2("cwd_lue0", "cwdx20") -->

<!-- ``` -->

<!-- ### LUE reduction at maximum CWD -->

<!-- Doesn't work well. -->

<!-- ```{r} -->

<!-- df <- df_sif |>  -->

<!--   arrange(desc(flue)) |>  -->

<!--   slice(1) |>  -->

<!--   pull(df) -->

<!-- df_sif |>  -->

<!--   dplyr::filter(!is.na(cwd_lue0))|>  -->

<!--   ggplot(aes(x = cwdmax, y = flue)) + -->

<!--   geom_point() -->

<!-- ``` -->

<!-- Along one longitude band (21.475 deg E). -->

<!-- ```{r} -->

<!-- load("~/mct/data/df_cwd_lue0/df_cwd_lue0_5000.RData") -->

<!-- df_cwd_lue0 <- df -->

<!-- load("data/df_cwdx/df_cwdx_ilon_5000.RData") -->

<!-- ## play around with return period -->

<!-- tmp <- df |>  -->

<!--   mutate(df_return = map(out_mct, "df_return")) |>  -->

<!--   mutate(cwdx20 = map_dbl(df_return, ~{filter(., return_period == 20) |> pull(return_level)})) -->

<!-- ggplot() +  -->

<!--   geom_line(data = df_cwd_lue0, aes(lat, cwd_lue0_nSIF), color = "red") + -->

<!--   geom_line(data = tmp, aes(lat, cwdx20)) -->

<!-- tmp <- tmp |>  -->

<!--   dplyr::select(lat, cwdx20) |>  -->

<!--   left_join( -->

<!--     df_cwd_lue0, by = "lat" -->

<!--   ) |>  -->

<!--   mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF)) |>  -->

<!--   mutate(cwd_lue0_nSIF = remove_outliers(cwd_lue0_nSIF)) |>  -->

<!--   filter(flue_nSIF < 0.8) |>  -->

<!--   mutate(lambda_decay_nSIF = remove_outliers(lambda_decay_nSIF)) -->

<!-- tmp |>  -->

<!--   analyse_modobs2("cwdx20", "cwd_lue0_nSIF") -->

<!-- tmp |>  -->

<!--   analyse_modobs2("cwdx20", "cwd_lue0_SIF") -->

<!-- tmp |>  -->

<!--   analyse_modobs2("cwdx20", "lambda_decay_nSIF") -->

<!-- ``` -->

## EF

Approach is to derive CWD(ET/Rn=0) for estimating CWDX.

Run script that wraps `calc_cwd_et0_byilon()` and `calc_cwd_et0()` (submission file: `submit_calc_cwd_et0.sh`). Collects CWD data (including instances), net radiation, and ET data into one data frame per pixel and determines sensitivity (linear regression slope) of ET/Rn vs. CWD. Also determines fractional reduction in ET/Rn in highest CWD bin (using function `get_fet_cwdmax()`).

Then collect outputs using `rscript_collect_cwd_et0.R` and read the file. It's huge, therefore split them up and re-write smaller files.

```{r}
load("data/df_cwd_et0_3.RData")
df_cwd_et0 <- df
rm("df")

## Detect flattening
df_cwd_et0 <- df_cwd_et0 |>
  mutate(flat_fet = ifelse(type_fet %in% c("Aa", "A1", "A2a"), TRUE, NA))

df_irr <- nc_to_df("~/data/irrigation/gmia_v5_aai_pct_0_05deg.nc", varnam = "aai") |> 
      drop_na() |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
      rename(irr = aai)

save(df_irr, file = "data/df_irr.RData")
save(df_cwd_et0, file = "data/df_cwd_et0_3_flattening.RData")
```
### Distribution of values

```{r}
df_cwd_et0 |> 
  ggplot(aes(x = cwd_lue0_fet, ..density..)) +
  geom_histogram() +
  xlim(0, 2500)
```


### Regional

```{r}
load("data/df_cwd_et0_3_flattening.RData")
load("data/df_rivers.RData")
load("data/df_irr.RData")
source("R/plot_map_cwdx_type_irrigation.R")

# ## apply vegetation mask
# load("data/df_vegmask.RData") # loads df_vegmask
# df_cwd_et0 <- df_cwd_et0 |> 
#   left_join(df_vegmask |> dplyr::select(lon, lat, vegmask),
#             by = c("lon", "lat")) |> 
#   mutate(cwd_lue0_fet = cwd_lue0_fet * vegmask)

## central asia, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_et0, 
  df_irr,
  name_cwdx = "cwd_lue0_fet", name_type = "flat_fet", name_irr = "irr",
  lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5,
  # lonmin = 52, lonmax = 85, latmin = 27, latmax = 45,
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = "(mm)", 
  hillshade = TRUE,
  rivers = TRUE,
  ocean = FALSE,
  scale = "medium",
  expand_size_y = 0.7,
  irr_cutoff = 0.3
  )
gg$ggmap <- gg$ggmap +
  labs(title = expression(paste(italic("S")[dEF]))) +
  # mountains
  annotate(geom = "text", x = 50.5, y = 32, label = "M", fontface = 2, color = "green") +
  annotate(geom = "text", x = 79.5, y = 36, label = "M", fontface = 2, color = "green") +
  annotate(geom = "text", x = 65, y = 34, label = "M", fontface = 2, color = "green") +
  # delta
  annotate(geom = "text", x = 49, y = 45.5, label = "D", fontface = 2, color = "green") +
  # river
  annotate(geom = "text", x = 63.3, y = 31.1, label = "R", fontface = 2, color = "green") +
  annotate(geom = "text", x = 66, y = 43.5, label = "R", fontface = 2, color = "green")

gg <- cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
gg
ggsave("fig/fig2.png", width = 10, height = 5)
ggsave("fig/fig2.pdf", width = 10, height = 5)

## save for publication figure
gg_fig1c <- gg
save(gg_fig1c, file = "data/gg_fig1c.Rdata")

## Western USA, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_et0, df_irr,
  name_cwdx = "cwd_lue0_fet", name_type = "flat_fet", name_irr = "irr",
  lonmin = -125, lonmax = -95, latmin = 32.5, latmax = 47, 
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = expression(paste(italic("S")[dEF], " (mm)")), 
  hillshade = TRUE,
  rivers = TRUE,
  scale = "medium",
  expand_size_y = 0.4,
  irr_cutoff = 0.3
  )
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
ggsave("fig/map_cwd_lue0_types_fet0_wusa.pdf", width = 10, height = 6)
ggsave("fig/map_cwd_lue0_types_fet0_wusa.png", width = 10, height = 6)


## Amazon, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_et0, df_irr,
  name_cwdx = "cwd_lue0_fet", name_type = "flat_fet", name_irr = "irr",
  lonmin = -83, lonmax = -33, latmin = -25, latmax = 12,
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = expression(paste(italic("S")[dEF], " (mm)")), 
  hillshade = TRUE,
  rivers = TRUE,
  scale = "medium",
  expand_size_y = 0.4,
  irr_cutoff = 0.3
  )
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
ggsave("fig/map_cwd_lue0_types_fet0_amazon.pdf", width = 9, height = 6)
ggsave("fig/map_cwd_lue0_types_fet0_amazon.png", width = 9, height = 6)


## Europe, multi layer map
gg <- plot_map_cwdx_type_irrigation(
  df_cwd_et0, df_irr,
  name_cwdx = "cwd_lue0_fet", name_type = "flat_fet", name_irr = "irr",
  lonmin = -10, lonmax = 25, latmin = 35, latmax = 55, 
  breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
  spacing = "constant",
  combine = FALSE, 
  colorscale = "batlowK", 
  legend_title = expression(paste(italic("S")[dEF], " (mm)")), 
  hillshade = TRUE,
  rivers = TRUE,
  scale = "medium",
  expand_size_y = 0.4,
  irr_cutoff = 0.3
  )
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.15))
ggsave("fig/map_cwd_lue0_types_fet0_europe.pdf", width = 8, height = 6)
ggsave("fig/map_cwd_lue0_types_fet0_europe.png", width = 8, height = 6)
```

Convert to nc object and write to file.

```{r}
## fET (ET/Rn)
nc <- df_to_grid(df_cwd_et0, varnam = "cwd_lue0_fet", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "cwd_lue0_fet", lon = df_cwd_et0$lon |> unique() |> sort(), lat = df_cwd_et0$lat |> unique() |> sort(), path = "data/cwd_lue0_fet.nc", make_zdim = FALSE)

## s0_teuling_et
nc <- df_to_grid(df_cwd_et0 |> mutate(s0_teuling_fet = remove_outliers(s0_teuling_fet, coef = 10)), varnam = "s0_teuling_et", lonnam = "lon", latnam = "lat")
write_nc2(nc, varnams = "s0_teuling_fet", lon = df_cwd_et0$lon |> unique() |> sort(), lat = df_cwd_et0$lat |> unique() |> sort(), path = "data/s0_teuling_fet.nc", make_zdim = FALSE)

## write as netcdf
load("data/df_cwd_et0_3_flattening.RData")

nc <- df_to_grid(df_cwd_et0, varnam = "flat_fet", lonnam = "lon", latnam = "lat")
image(nc)
write_nc2(nc, 
          varnams = "flat_fet", 
          lon = df_cwd_et0$lon |> unique() |> sort() |> round(digits = 3), 
          lat = df_cwd_et0$lat |> unique() |> sort() |> round(digits = 3), 
          path = "data/flat_fet.nc", 
          make_zdim = FALSE
          )
raster("data/flat_fet.nc")

lon_orig <- df_cwd_et0$lon |> unique() |> sort() |> round(digits = 3)
lon <- seq(min(lon_orig), max(lon_orig), by = 0.05)

lat_orig <- df_cwd_et0$lat |> unique() |> sort() |> round(digits = 3)
lat <- seq(min(lat_orig), max(lat_orig), by = 0.05)

df_tmp <- expand.grid(lon, lat) |> 
  as_tibble() |> 
  setNames(c("lon", "lat")) |> 
  mutate(lon = as.factor(lon),
         lat = as.factor(lat)) |> 
  left_join(
    df_cwd_et0 |> 
      mutate(lon = round(lon, digits = 3),
             lat = round(lat, digits = 3)) |> 
      mutate(lon = as.factor(lon),
             lat = as.factor(lat)),
    by = c("lon", "lat")
  ) |> 
  mutate(lon = as.numeric(lon),
         lat = as.numeric(lat))

nc2 <- df_to_grid(df_tmp, varnam = "flat_fet", lonnam = "lon", latnam = "lat")
image(nc2)

write_nc2(nc2, 
          varnams = "flat_fet", 
          lon = df_tmp$lon |> unique() |> sort(), 
          lat = df_tmp$lat |> unique() |> sort(), 
          path = "data/flat_fet.nc", 
          make_zdim = FALSE
          )

## test
image(nc)

rasta <- raster::raster("data/flat_fet.nc")
library(rasterVis)
rasterVis::levelplot(rasta)
```


### Flattening analysis

Combine data frames, including irrigation information, and vegetation types.
```{r}
df_lc <- nc_to_df("~/data/landcover/modis_landcover__LPDAAC__v5.1__0.05deg__2010.nc", 
                    varnam = "landcover") |> 
  mutate(lon = round(lon, digits = 1) - 0.05/2, lat = round(lat, digits = 1) - 0.05/2) |> 
  mutate(savannah_w = ifelse(landcover %in% c(9, 10), TRUE, FALSE), 
         savannah   = ifelse(landcover == 9, TRUE, FALSE))

# load("data/df_gti.RData")

df_tmp <- df_cwd_et0 |> 
  dplyr::select(lon, lat, flat_fet) |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  left_join(df_irr |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)), 
    by = c("lon", "lat")) |> 
  left_join(df_lc, by = c("lon", "lat")) |> 
  left_join(
    nc_to_df("~/data/gti_marthews/ga2_0_05deg_median.nc", varnam = "gti") |>
      drop_na() |>
      rename(gti = myvar) |>
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)),
    by = c("lon", "lat"))

plot_map3(df_tmp, varnam = "landcover")

n_fun <- function(x){
  return(data.frame(y = 520,
                    label = length(x)))
}

## only woody savannah
gg1 <- df_tmp |> 
  drop_na(savannah) |> 
  group_by(savannah) |> 
  summarise(n_flat = sum(flat_fet, na.rm = TRUE), f_flat = sum(flat_fet, na.rm = TRUE)/n(), count = n()) |> 
  drop_na() |> 
  ggplot(aes(savannah, f_flat)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  labs(x = "Savannah", y = "Fraction flattening")

## all land cover types
gg1b <- df_tmp |> 
  drop_na(landcover) |> 
  group_by(landcover) |> 
  summarise(f_flat = sum(flat_fet, na.rm = TRUE)/n()) |> 
  drop_na() |> 
  ggplot(aes(landcover, f_flat)) +
  geom_bar(stat = "identity") +
  stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5, size = 3) +
  theme_classic() +
  labs(x = "Land cover", y = "Fraction flattening")

## by bins in irrigated area fraction
df_irrbin <- df_tmp |> 
  drop_na(irr) |> 
  mutate(irr_bin = cut(irr, breaks = seq(0, 1, by = 0.2))) |> 
  group_by(irr_bin) |> 
  summarise(f_flat = sum(flat_fet, na.rm = TRUE)/n())

save(df_irrbin, file = "data/df_irrbin.RData")

gg2 <- df_irrbin |> 
  drop_na() |> 
  ggplot(aes(irr_bin, f_flat)) +
  geom_bar(stat = "identity") +
  stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5, size = 3) +
  theme_classic() +
  labs(x = "Irrigated area fraction (bins)", y = "Fraction flattening")

## create publication figure
plot_grid(gg1, gg2, ncol = 2, labels = c('a', 'b'))
ggsave("fig/flattening_analysis.pdf", width = 8, height = 4)
ggsave("fig/flattening_analysis.png", width = 8, height = 4)
```


### Global

Regrid to 0.1 deg.
```{r}
load("data/df_cwd_et0_3.RData")
df_cwd_et0 <- df
rm("df")

## add vegetation mask (fraction of non-vegetated)
load("data/df_vegmask.RData") # loads df_vegmask
df_cwd_et0 <- df_cwd_et0 |>
  left_join(df_vegmask |> dplyr::select(lon, lat, nonveg),
            by = c("lon", "lat"))

dlon <- 0.1
dlat <- 0.1
lon_breaks <- seq(from = floor(min(df_cwd_et0$lon)), to = ceiling(max(df_cwd_et0$lon)), by = dlon)
lat_breaks <- seq(from = floor(min(df_cwd_et0$lat)), to = ceiling(max(df_cwd_et0$lat)), by = dlat)

df_cwd_et0 <- df_cwd_et0 |>
  ungroup() |>
  mutate(ilon = cut(lon,
                    breaks = lon_breaks
                    ),
         ilat = cut(lat,
                    breaks = lat_breaks
                    )
         ) |>
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )
         ) |>
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) |>

  ## create cell name to associate with climate input
  dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper)

df_cwd_et0_agg <- df_cwd_et0 |> 
  group_by(lon_mid, lat_mid) |> 
  summarise(cwd_lue0_fet = mean(cwd_lue0_fet, na.rm = TRUE),
            nonveg = mean(nonveg, na.rm = TRUE)) |> 
  rename(lon = lon_mid, lat = lat_mid) |> 
  mutate(cwd_lue0_fet = ifelse(is.nan(cwd_lue0_fet), NA, cwd_lue0_fet))

save(df_cwd_et0_agg, file = "data/df_cwd_et0_agg.RData")
```

Read tenth-degree global file and plot.

```{r}
load("data/df_cwd_et0_agg.RData")

df_box <- tibble(
  long = c(45, 95, 95, 45, 45), lat = c(47.5, 47.5, 25, 25, 47.5),
  # long = c(52, 85, 85, 52, 52), lat = c(45, 45, 27, 27, 45), 
  order = 1:5, group = rep(1, 5)
  )

## apply vegetation mask
df_cwd_et0_agg <- df_cwd_et0_agg |> 
  mutate(cwd_lue0_fet = ifelse(nonveg > 0.99, NA, cwd_lue0_fet)) |> 
  mutate(cwd_lue0_fet = ifelse(lat > 74, NA, cwd_lue0_fet))  # implausible values higher north
  
## EF
gg <- plot_map4(df_cwd_et0_agg, 
                varnam = "cwd_lue0_fet", 
                breaks = c(seq(0, 100, by = 20), 150, 200, 300, 500, 700, 900, 1200, Inf), 
                latmin = -60, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = FALSE, 
                colorscale = "batlowK", 
                legend_title = NULL, # "(mm)",
                hillshade = FALSE,
                rivers = FALSE,
                expand_size_y = 0.5,
                ocean = TRUE,
                legend_direction = "horizontal")
gg$ggmap <- gg$ggmap + 
  labs(title = expression(paste(italic("S")[dEF]))) +
  ## add red box for zoom
  geom_path(aes(x = long, y = lat, group = group), data = df_box, size = 0.3, color = "red", )
  
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_heights = c(1, 0.2))
ggsave("fig/map_cwd_lue0_fet.pdf", width = 10, height = 6)
ggsave("fig/map_cwd_lue0_fet.png", width = 10, height = 6)

gg_fig1a <- gg$ggmap
save(gg_fig1a, file = "data/gg_fig1a.Rdata")

gg_fig1_legend <- gg$gglegend
save(gg_fig1_legend, file = "data/gg_fig1_legend.Rdata")
```



Plot correlation at global scale.

Coarse resolution.

```{r}
df_corr <- read_nc_onefile("data/cwdx20_halfdeg.nc", varnam = "cwdx20") |> 
  nc_to_df(varnam = "cwdx20") |> 
  rename(cwdx20 = myvar) |> 
  left_join(
    read_nc_onefile("data/cwd_lue0_et_halfdeg.nc", varnam = "cwd_lue0_et") |> 
      nc_to_df(varnam = "cwd_lue0_et") |> 
      rename(cwd_lue0_et = myvar),
    by = c("lon", "lat")
  ) |> 
  left_join(
    read_nc_onefile("data/cwd_lue0_et_halfdeg.nc", varnam = "cwd_et0_fet") |> 
      nc_to_df(varnam = "cwd_et0_fet") |> 
      rename(cwd_et0_fet = myvar),
    by = c("lon", "lat")
  ) |> 
  left_join(
    read_nc_onefile("data/s0_teuling_et_halfdeg.nc", varnam = "s0_teuling_et") |> 
      nc_to_df(varnam = "cwd_et0_fet") |> 
      rename(cwd_et0_fet = myvar),
    by = c("lon", "lat")
  )

out <- df_corr |> 
  filter(cwdx20 < 1000 & cwd_lue0_et < 1000) |> # TEST XXX
  analyse_modobs2("cwdx20", "cwd_lue0_et", type = "heat")
out$gg

df_corr |> 
  filter(cwdx20 < 1000 & cwd_et0_fet < 1000) |> # TEST XXX
  analyse_modobs2("cwdx20", "cwd_et0_fet", type = "heat")

df_corr |> 
  filter(cwdx20 < 1000 & s0_teuling_et < 1000) |> # TEST XXX
  analyse_modobs2("cwdx20", "s0_teuling_et", type = "heat")
```

At high resolution.

```{r}
df_corr <- df_cwdx |> 
  left_join(
    df |> 
      dplyr::select(lon, lat, cwd_lue0_et, cwd_lue0_fet, s0_teuling_et),
    by = c("lon", "lat")
  )

out <- df_corr |> 
  mutate(cwd_lue0_et = remove_outliers(cwd_lue0_et, coef = 5)) |> 
  analyse_modobs2("cwdx20", "cwd_lue0_et", type = "hex", plot_linmod = FALSE)
out$gg +
  scale_x_continuous(expand = c(0,0), limits = c(0,100)) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,100))

out <- df_corr |> 
  mutate(cwd_lue0_fet = remove_outliers(cwd_lue0_fet, coef = 5)) |> 
  analyse_modobs2("cwdx20", "cwd_lue0_fet", type = "hex", plot_linmod = FALSE)
out$gg +
  scale_x_continuous(expand = c(0,0), limits = c(0,100)) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,100))

# out <- df_corr |> 
#   mutate(cwd_lue0_et = remove_outliers(cwd_lue0_et, coef = 5)) |> 
#   analyse_modobs2("s0_teuling_et", "cwd_lue0_et", type = "hex", plot_linmod = FALSE)
# out$gg +
#   scale_x_continuous(expand = c(0,0), limits = c(0,1000)) + 
#   scale_y_continuous(expand = c(0,0), limits = c(0,100))
```

### Correlation SIF and EF

```{r}
tmp <- df_cwd_lue0 |> 
  dplyr::select(lon, lat, cwd_lue0_nSIF) |> 
  left_join(df_cwd_et0 |> 
              dplyr::select(lon, lat, cwd_lue0_fet), 
            by = c("lon", "lat"))

out <- tmp |> 
  analyse_modobs2("cwd_lue0_fet", "cwd_lue0_nSIF", type = "hex", plot_linmod = FALSE)
gg_corr <- out$gg +
  scale_x_continuous(expand = c(0,0), limits = c(0,1200)) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,1200)) +
  labs(x = expression(italic(S)[dEF] ~ " (mm)"), 
       y = expression(italic(S)[dSIF] ~ " (mm)")) +
  scale_fill_gradientn(
        colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), 
        trans = "log", breaks = c(1, 10, 100, 1000, 10000))
gg_corr
ggsave("fig/corr_cwd_lue0_nSIF_EF.pdf", width = 6, height = 5)
ggsave("fig/corr_cwd_lue0_nSIF_EF.png", width = 6, height = 5)
```

## Bias analysis

Combine data.

```{r}
load("data/df_cwdx_10_20_40.RData") # loads 'df', created by rscript_collect_cwdx.R
df_cwdx <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 

## new version
load("data/df_cwd_lue0_2.RData")
df_cwd_lue0 <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 
rm("df")

load("data/df_cwd_et0_3.RData")  # loads 'df'
df_cwd_et0 <- df |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) 
rm("df")

## old version
# load("data/df_cwd_lue0_SIF.RData")
# load("data/df_cwd_lue0_nSIF.RData")
# load("data/df_cwd_lue0_et.RData")
# load("data/df_cwd_lue0_fet.RData")

nc_landcover <- read_nc_onefile("~/data/landcover/modis_landcover__LPDAAC__v5.1__0.05deg__2010.nc", varnam = "landcover")
df_biome <- read_csv("~/data/biomes/wwf_ecoregions/biome_id.csv") |> 
  rename(biome = biome_id)

df_corr <- df_cwdx |> 
  left_join(df_cwd_lue0, by = c("lon", "lat")) |> 
  left_join(df_cwd_et0, by = c("lon", "lat")) |> 
  left_join(
    nc_to_df("~/data/biomes/wwf_ecoregions/official/wwf_terr_ecos_raster.nc", varnam = "biome") |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)),
    by = c("lon", "lat")
  ) |> 
  left_join(nc_to_df(nc_landcover, varnam = "landcover") |> 
              mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)), 
            by = c("lon", "lat")) |> 
  left_join(df_biome, by = "biome") |> 
  mutate(forest = biome %in% c(1,2,3,4,5,6,12),
         grassland = biome %in% c(7,8))

save(df_corr, file = "data/df_corr.RData")
```

<!-- ### Bias by return period and vegetation type -->

<!-- Distinguishing grasslands and forests. -->

<!-- ```{r} -->
<!-- #load("data/df_corr.RData") -->

<!-- df_corr_bias <- df_corr |> -->
<!--   mutate(bias_sif_10 = -log(cwdx10 / cwd_lue0_nSIF), -->
<!--          bias_sif_20 = -log(cwdx20 / cwd_lue0_nSIF), -->
<!--          bias_sif_40 = -log(cwdx40 / cwd_lue0_nSIF), -->
<!--          bias_sif_80 = -log(cwdx80 / cwd_lue0_nSIF), -->
<!--          bias_sif_100 = -log(cwdx100 / cwd_lue0_nSIF), -->
<!--          bias_sif_200 = -log(cwdx200 / cwd_lue0_nSIF), -->

<!--          bias_fet_10 = -log(cwdx10 / cwd_lue0_fet), -->
<!--          bias_fet_20 = -log(cwdx20 / cwd_lue0_fet), -->
<!--          bias_fet_40 = -log(cwdx40 / cwd_lue0_fet), -->
<!--          bias_fet_80 = -log(cwdx80 / cwd_lue0_fet), -->
<!--          bias_fet_100 = -log(cwdx100 / cwd_lue0_fet), -->
<!--          bias_fet_200 = -log(cwdx200 / cwd_lue0_fet) -->
<!--          ) -->

<!-- df_corr_fet <- df_corr_bias |> -->
<!--   dplyr::select(lon, lat, cwd_lue0_fet) |> -->
<!--   drop_na() -->
<!-- save(df_corr_fet, file = "data/df_corr_fet.RData") -->

<!-- df_corr_nSIF <- df_corr_bias |> -->
<!--   select(lon, lat, cwd_lue0_nSIF) |> -->
<!--   drop_na() -->
<!-- save(df_corr_nSIF, file = "data/df_corr_nSIF.RData") -->

<!-- ## violin plots of bias by return period using SIF -->
<!-- df_corr_bias |> -->
<!--   dplyr::select(starts_with("bias_sif_")) |> -->
<!--   pivot_longer(cols = everything(), names_to = "return_period", values_to = "bias", names_prefix = "bias_sif_") |> -->
<!--   mutate(return_period = as.factor(as.integer(return_period))) |> -->
<!--   ggplot(aes(x = return_period, y = bias)) + -->
<!--   geom_violin(draw_quantiles = 0.5) + -->
<!--   labs(x = expression("Return period used for S"[CWDX]), y = expression("log(S"[dSIF] ~ "/S"[CWDX] ~ ")")) + -->
<!--   geom_hline(yintercept = 0, linetype = "dotted") -->

<!-- ggsave("fig/bias_sif_dsif2.pdf", width = 6, height = 4) -->
<!-- ggsave("fig/bias_sif_dsif2.png", width = 6, height = 4) -->

<!-- ## boxplot of bias by return period and vegetation type -->
<!-- df_corr_bias |> -->
<!--   mutate(vegetation = ifelse(forest, "forest", ifelse(grassland, "grassland", NA))) |> -->
<!--   dplyr::select(starts_with("bias_sif_"), vegetation) |> -->
<!--   drop_na(vegetation) |> -->
<!--   pivot_longer(cols = starts_with("bias_sif_"), names_to = "return_period", values_to = "bias", names_prefix = "bias_sif_") |> -->
<!--   mutate(return_period = as.factor(as.integer(return_period))) |> -->
<!--   ggplot(aes(x = return_period, y = bias, fill = vegetation)) + -->
<!--   geom_boxplot(outlier.shape = NA) + -->
<!--   labs(x = expression("Return period used for S"[CWDX]), y = expression("log(S"[dSIF] ~ "/S"[CWDX] ~ ")")) + -->
<!--   geom_hline(yintercept = 0, linetype = "dotted") -->

<!-- ggsave("fig/bias_sif_dsif_vegtype.pdf", width = 6, height = 4) -->
<!-- ggsave("fig/bias_sif_dsif_vegtype.png", width = 6, height = 4) -->


<!-- ## violin plot using EF -->
<!-- df_corr_bias |> -->
<!--   dplyr::select(starts_with("bias_fet_")) |> -->
<!--   pivot_longer(cols = everything(), names_to = "return_period", values_to = "bias", names_prefix = "bias_fet_") |> -->
<!--   mutate(return_period = as.factor(as.integer(return_period))) |> -->
<!--   ggplot(aes(x = return_period, y = bias)) + -->
<!--   geom_violin(draw_quantiles = 0.5) + -->
<!--   labs(x = expression("Return period used for S"[CWDX]), y = expression("log(S"[dEF] ~ "/S"[CWDX] ~ ")")) + -->
<!--   geom_hline(yintercept = 0, linetype = "dotted") -->

<!-- ggsave("fig/bias_dfet.pdf", width = 6, height = 4) -->
<!-- ggsave("fig/bias_dfet.png", width = 6, height = 4) -->


<!-- ## boxplot by veg type using EF -->
<!-- df_corr_bias |> -->
<!--   mutate(vegetation = ifelse(forest, "forest", ifelse(grassland, "grassland", NA))) |> -->
<!--   dplyr::select(starts_with("bias_fet_"), vegetation) |> -->
<!--   drop_na(vegetation) |> -->
<!--   pivot_longer(cols = starts_with("bias_fet_"), names_to = "return_period", values_to = "bias", names_prefix = "bias_fet_") |> -->
<!--   mutate(return_period = as.factor(as.integer(return_period))) |> -->
<!--   ggplot(aes(x = return_period, y = bias, fill = vegetation)) + -->
<!--   geom_boxplot(outlier.shape = NA) + -->
<!--   labs(x = expression("Return period used for S"[CWDX]), y = expression("log(S"[dEF] ~ "/S"[CWDX] ~ ")")) + -->
<!--   geom_hline(yintercept = 0, linetype = "dotted") -->

<!-- ggsave("fig/bias_dfet_vegtype.pdf", width = 6, height = 4) -->
<!-- ggsave("fig/bias_dfet_vegtype.png", width = 6, height = 4) -->
<!-- ``` -->

<!-- Hi-res return period analysis. -->
<!-- ```{r} -->
<!-- load("data/df_rl/df_rl_fet_ichunk_10_30.RData") -->
<!-- ``` -->


<!-- ### Bias map -->

<!-- ```{r} -->
<!-- #load("data/df_rivers.RData") -->

<!-- ## central asia -->
<!-- gg <- df_corr_bias |> -->
<!--   plot_map3(varnam = "bias_20", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5, -->
<!--             spacing = "constant", -->
<!--             breaks = c(4, 2, 1, 0.5, 0.2, 0, -0.2, -0.5, -1, -2, -4), -->
<!--             combine = FALSE, -->
<!--             colorscale = c( "royalblue4", "royalblue2", "wheat", "tomato2", "tomato4" ), -->
<!--             legend_title = "(unitless)" -->
<!--             ) -->
<!-- gg$ggmap <- gg$ggmap + -->
<!--   labs(title =  expression("log(S"[dSIF] ~ "/S"[CWDX] ~ ")")) + -->
<!--   geom_path(data = df_rivers, aes(x = long, y = lat, group = group), color = "dodgerblue", size = 0.2) -->
<!-- cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_widths = c(1, 0.2)) -->
<!-- ggsave("fig/map_bias_cwdx20_casia.pdf", width = 9, height = 5) -->
<!-- ggsave("fig/map_bias_cwdx20_casia.png", width = 9, height = 5) -->
<!-- ``` -->

## Diagnose the return period

OLD: Tried with deriving return level directly from SIF and EF-based S0. 
<!-- Given the SIF and EF-based S0, back-calculate the return period for each gridcell, using the fitted Gumbel parameters for the respective cell. This is done with the script `rscript_rp_diag.R`, then `rscript_collect_rp_diag.R`. -->

For each gridcell, use fitted Gumbel distribution to calculate return level for a set of return periods. This is done with `rscript_return_level.R` and `rscript_collect_rl.R`. The latter writes `"data/df_rl_nSIF.RData"` and `"data/df_rl_fet.RData"`.

### ET

```{r}
load("data/df_rl_fet.RData")  # loads df_rl_fet

## function to determine the return period with the lowest bias (absolute)
find_rp_diag <- function(df){
  out <- df |> 
    group_by(return_period) |> 
    summarise(logbias = median(logbias, na.rm = TRUE)) |> 
    slice(which.min(abs(logbias))) |> 
    pull(return_period)
  out <- ifelse(length(out)==0, NA, out)
  return(out)
}

## bin into gridcells to be able to get a distribution (0.5 deg contains a maximum of 100 pixels)
dlon <- 1
dlat <- 1
lon_breaks <- seq(from = -180, to = 180, by = dlon)
lat_breaks <- seq(from = -90, to = 90, by = dlat)

## this takes about 1 min
df_rl_agg_fet <- df_rl_fet |>
  ungroup() |> 
  mutate(ilon = cut(lon, 
                    breaks = lon_breaks
                    # labels = as.character(seq(length(lon_breaks)-1))
                    ),
         ilat = cut(lat, 
                    breaks = lat_breaks
                    # labels = as.character(seq(length(lat_breaks)-1))
                    )
         ) |> 
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )
         ) |> 
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) |> 
  dplyr::select(-ilon, -ilat, -lon_lower, -lat_lower, -lat_upper, -lon_upper) |> 
  
  ## nest by gridcell and determine return period for which the absolute of the bias is lowest
  group_by(lon_mid, lat_mid) |> 
  nest() |> 
  ungroup() |> 
  mutate(rp_diag = purrr::map_dbl(data, ~find_rp_diag(.))) |> 
  dplyr::select(-data) |> 
  rename(lon = lon_mid, lat = lat_mid)

save(df_rl_agg_fet, file = "data/df_rl_agg_fet.RData")

## distribution of diagnosed return periods
df_rl_agg_fet |> 
  ggplot(aes(rp_diag, ..count..)) + 
  geom_histogram()

## global analysis of best return period
df_rl_fet |> 
  ggplot(aes(as.factor(return_period), logbias)) +
  # geom_violin(draw_quantiles = 0.5) +
  geom_boxplot(outlier.shape = NA) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  ylim(-1.2, 1.2)

save(df_rl_fet, file = "data/df_rl_fet.RData")
```

Convert to map and plot.
```{r}
load("data/df_rl_agg_fet.RData")

# nc <- df_to_grid(
#   df_rl_agg, 
#   varnam = "rp_diag", 
#   lonnam = "lon", latnam = "lat"
#   )

df_rl_agg_fet <- df_rl_agg_fet |> 
  mutate(rp_diag = ifelse(lat > 75, NA, rp_diag))

gg <- plot_map4(df_rl_agg_fet, 
                varnam = "rp_diag", 
                breaks = c(seq(0, 500, by = 50), Inf), 
                latmin = -57, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = FALSE, 
                colorscale = viridis::magma, 
                legend_title = "",
                hillshade = FALSE,
                rivers = FALSE,
                ocean = TRUE,
                expand_size_y = 0.5,
                legend_direction = "horizontal"
                )
gg$ggmap <- gg$ggmap + labs(title = expression(italic(T)[EF]))
cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 1, rel_heights = c(1, 0.3))
gg_fig4a <- gg$ggmap
gg_fig4_legend <- gg$gglegend
save(gg_fig4a, file = "data/gg_fig5a.Rdata")

ggsave("fig/map_rp_fet.pdf", width = 8, height = 5)
ggsave("fig/map_rp_fet.png", width = 8, height = 5)
```

### SIF

```{r}
load("data/df_rl_nSIF.RData")

# ## xxx debug
# load("data/df_rl/df_rl_fet_ichunk_TEST.RData")  # loads df
# df_rl_fet <- df

## function to determine the return period with the lowest bias (absolute)
find_rp_diag <- function(df){
  out <- df |> 
    group_by(return_period) |> 
    summarise(logbias = median(logbias, na.rm = TRUE)) |> 
    slice(which.min(abs(logbias))) |> 
    pull(return_period)
  out <- ifelse(length(out)==0, NA, out)
  return(out)
}

## bin into gridcells to be able to get a distribution (0.5 deg contains a maximum of 100 pixels)
dlon <- 1
dlat <- 1
lon_breaks <- seq(from = -180, to = 180, by = dlon)
lat_breaks <- seq(from = -90, to = 90, by = dlat)

## this takes about 1 min
df_rl_agg_nSIF <- df_rl_nSIF |>
  ungroup() |> 
  mutate(ilon = cut(lon, 
                    breaks = lon_breaks
                    # labels = as.character(seq(length(lon_breaks)-1))
                    ),
         ilat = cut(lat, 
                    breaks = lat_breaks
                    # labels = as.character(seq(length(lat_breaks)-1))
                    )
         ) |> 
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )
         ) |> 
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) |> 
  dplyr::select(-ilon, -ilat, -lon_lower, -lat_lower, -lat_upper, -lon_upper) |> 
  
  ## nest by gridcell and determine return period for which the absolute of the bias is lowest
  group_by(lon_mid, lat_mid) |> 
  nest() |> 
  ungroup() |> 
  mutate(rp_diag = purrr::map_dbl(data, ~find_rp_diag(.))) |> 
  dplyr::select(-data) |> 
  rename(lon = lon_mid, lat = lat_mid)

save(df_rl_agg_nSIF, file = "data/df_rl_agg_nSIF.RData")

## distribution of diagnosed return periods
df_rl_agg_nSIF |> 
  ggplot(aes(rp_diag, ..count..)) + 
  geom_histogram()

## global analysis of best return period
df_rl_nSIF |> 
  ggplot(aes(as.factor(return_period), logbias)) +
  # geom_violin(draw_quantiles = 0.5) +
  geom_boxplot(outlier.shape = NA) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  ylim(-1.2, 1.2)
```

Convert to map and plot.
```{r}
load("data/df_rl_agg_nSIF.RData")

# nc <- df_to_grid(
#   df_rl_agg, 
#   varnam = "rp_diag", 
#   lonnam = "lon", latnam = "lat"
#   )

df_rl_agg_nSIF <- df_rl_agg_nSIF |> 
  mutate(rp_diag = ifelse(lat > 75, NA, rp_diag))

gg <- plot_map4(df_rl_agg_nSIF, 
                varnam = "rp_diag", 
                breaks = c(seq(0, 500, by = 50), Inf), 
                latmin = -57, latmax = 80,
                spacing = "constant", 
                maxval = 6000, 
                combine = FALSE, 
                colorscale = viridis::magma, 
                legend_title = "(yr)",
                hillshade = FALSE,
                rivers = FALSE,
                ocean = TRUE,
                expand_size_y = 0.5)
gg$ggmap <- gg$ggmap + labs(title = expression(italic(T)[SIF]))

gg_fig4b <- gg$ggmap
save(gg_fig4b, file = "data/gg_fig5b.Rdata")

ggsave("fig/map_rp_nsif.pdf", width = 8, height = 5)
ggsave("fig/map_rp_nsif.pdf", width = 8, height = 5)

# ## missing lon-bands
# tmp <- df_rl_fet |>
#   ungroup() |> 
#   mutate(ilon = cut(lon, 
#                     breaks = lon_breaks
#                     # labels = as.character(seq(length(lon_breaks)-1))
#                     ),
#          ilat = cut(lat, 
#                     breaks = lat_breaks
#                     # labels = as.character(seq(length(lat_breaks)-1))
#                     )
#          ) |> 
#   mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
#          lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
#          lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
#          lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )
#          ) |> 
#   mutate(lon_mid = (lon_lower + lon_upper)/2,
#          lat_mid = (lat_lower + lat_upper)/2) |> 
#   dplyr::select(-ilon, -ilat, -lon_lower, -lat_lower, -lat_upper, -lon_upper) |> 
#   group_by(lon_mid, lat_mid) |> 
#   nest() |> 
#   mutate(count = map_int(data, ~nrow(.)))
# 
# tmp |> 
#   dplyr::filter(lon_mid > 120 & lon_mid < 121)
#   # dplyr::filter(lon_mid == 120.5)
```

### EF and SIF combined analysis

Take mean across two maps.
```{r}
df_rl_agg <- df_rl_agg_nSIF |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  rename(rp_diag_nsif = rp_diag) |> 
  left_join(df_rl_agg_fet |> 
              mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
              rename(rp_diag_fet = rp_diag),
            by = c("lon", "lat")) |> 
  mutate(rp_diag = ifelse(is.na(rp_diag_nsif), 
                          rp_diag_fet, 
                          ifelse(is.na(rp_diag_fet), 
                                 rp_diag_nsif,
                                 (rp_diag_fet + rp_diag_nsif) / 2)))

save(df_rl_agg, file = "data/df_rl_agg.RData")
```

Plot mean map.
```{r}
plot_map4(df_rl_agg, varnam = "rp_diag")
ggsave("fig/map_rl.pdf", width = 12, height = 8)
```
Check: RL ~ GTI + f_forest + AI

Get data at 1 deg resolution.
```{r}
df_rl_agg_test <- df_rl_agg |> 
  mutate(lon = round(lon, digits = 1), lat = round(lat, digits = 1))

tmp_gti <- nc_to_df("~/data/gti_marthews/ga2_1deg.nc", varnam = "gti") |> 
      mutate(lat = lat - 0.1) |> 
      mutate(lon = round(lon, digits = 1), lat = round(lat, digits = 1)) |>
      mutate(gti = ifelse(gti < 0, NA, gti))

tmp_wtd <- nc_to_df("~/data/watertable_fan13sci/Global_wtd_lowres_1.0deg.nc", varnam = "WTD") |> 
      mutate(lon = round(lon, digits = 1), lat = round(lat, digits = 1))

tmp_fcf <- nc_to_df("~/data/modis_forestcover/MODIS-TERRA_C6__MOD44B__ForestCoverFraction__LPDAAC__GLOBAL__1.0degree__UHAM-ICDC__20100306__fv0.02.nc", varnam = "forestcoverfraction") |> 
          mutate(lon = round(lon, digits = 1), lat = round(lat, digits = 1))  |> 
          mutate(forestcoverfraction = forestcoverfraction / 100)
  
tmp_pll <- nc_to_df("~/data/pelletier/average_soil_and_sedimentary-deposit_thickness_1x1deg.nc", varnam = "layer") |> 
          mutate(lon = round(lon, digits = 1), lat = round(lat, digits = 1))  |> 
          rename(ssdth = layer)


df_rl_agg_test <- tmp_gti |> 
  left_join(tmp_fcf, by = c("lon", "lat")) |> 
  left_join(df_rl_agg_test, by = c("lon", "lat")) |> 
  left_join(tmp_wtd, by = c("lon", "lat")) |> 
  left_join(tmp_pll, by = c("lon", "lat")) |> 
  mutate(gti_bin = cut(gti, breaks = c(1:4, 10)),
         fcf_bin = cut(forestcoverfraction, c(seq(0, 0.5, by = 0.1), 0.9)),
         wtd_bin = cut(WTD, c(0, 5, 10, 15, 200)),
         ssdth_bin = cut(ssdth, seq(0, 50, by = 5))) |> 
  mutate(forest = ifelse(forestcoverfraction > 0.4, TRUE, FALSE))

save(df_rl_agg_test, file = "data/df_rl_agg_test.Rdata")
```

Visualisations
```{r}
load("data/df_rl_agg_test.Rdata")

n_fun <- function(x){
  return(data.frame(y = 520,
                    label = length(x)))
}

gg_fig5c <- df_rl_agg_test |>
  drop_na(rp_diag) |> 
  drop_na(gti_bin, rp_diag) |> 
  ggplot(aes(x = gti_bin, y = rp_diag)) +
  geom_boxplot(fill = "grey70") +
  stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5, size = 3) +
  theme_classic() +
  ylim(0, 520) +
  labs(x = "CTI", y = "Return period (yr)")

gg_fig5d <- df_rl_agg_test |> 
  drop_na(fcf_bin, rp_diag) |> 
  ggplot(aes(x = fcf_bin, y = rp_diag)) +
  geom_boxplot(fill = "grey70") +
  stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5, size = 3) +
  theme_classic() +
  ylim(0, 520) +
  labs(x = "Forest cover fraction", y = "Return period (yr)")

gg_fig5e <- df_rl_agg_test |> 
  drop_na(ssdth_bin, rp_diag) |> 
  ggplot(aes(x = ssdth_bin, y = rp_diag)) +
  geom_boxplot(fill = "grey70") +
  stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5) +
  theme_classic() +
  labs(x = "Soil and sedimentary deposit thickness", y = "Return period (yr)")

gg_fig5c
gg_fig5d
gg_fig5e
```

Maps
```{r}
plot_map3(df_rl_agg_test, varnam = "rp_diag")
plot_map3(df_rl_agg_test, varnam = "gti", breaks = c(1, seq(from = 2, to = 7, by = 0.5), 10))
plot_map3(df_rl_agg_test, varnam = "forestcoverfraction")
plot_map3(df_rl_agg_test, varnam = "test")
plot_map3(df_rl_agg_test, varnam = "WTD", breaks = c(0, 5, 10, 15, 20, 100, 200))
```

Train linear regression model. WTD and soil/sedimentary deposit thickness are not significant.
```{r}
print("-----with WTD-------")
linmod <- lm(rp_diag ~ gti + forestcoverfraction + WTD, data = df_rl_agg_test)
summary(linmod)

print("-----without WTD-------")
linmod <- lm(rp_diag ~ gti + forestcoverfraction, data = df_rl_agg_test)
summary(linmod)

print("-----with soil and sedimentary deposit thickness-------")
linmod <- lm(rp_diag ~ gti + forestcoverfraction + WTD + ssdth, data = df_rl_agg_test)
summary(linmod)
```

Train random forest -- doesn't work
```{r}
library(ranger)
mod_rp_diag <- ranger(
  rp_diag ~ gti + forestcoverfraction, 
  data = df_rl_agg_test |> 
    ungroup() |> 
    dplyr::select(rp_diag, gti, forestcoverfraction) |> 
    drop_na(rp_diag, gti, forestcoverfraction),
  mtry = 1,
  respect.unordered.factors = "order",
  seed = 123
)

## RMSE and R2
sqrt(mod_rp_diag$prediction.error)
mod_rp_diag$r.squared
```

### Explaining the bias

#### Get covariates

Explaining actually SdSIF using SCWDX, CTI, groundwater table depth, vegetation type, and irrigation area fraction.

Read WTD data.

```{r}
## read groundwater table maps per continent
## africa
df_wtd <- nc_to_df("~/data/watertable_fan13sci/Africa_model_wtd_v2_0.05deg_CLEAN.nc", varnam = "WTD") |> 
  rename(wtd = myvar) |> 
  mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
  drop_na() |> 

  ## australia
  bind_rows(
    nc_to_df("~/data/watertable_fan13sci/Australia_model_wtd_v2_0.05deg_CLEAN.nc", varnam = "WTD") |> 
      rename(wtd = myvar) |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      drop_na()
    ) |> 

  ## eurasia
  bind_rows(
    nc_to_df("~/data/watertable_fan13sci/Eurasia_model_wtd_v2_0.05deg_CLEAN.nc", varnam = "WTD") |> 
      rename(wtd = myvar) |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      drop_na()
    ) |> 

  ## n america
  bind_rows(
    nc_to_df("~/data/watertable_fan13sci/N_America_model_wtd_v2_0.05deg_CLEAN.nc", varnam = "WTD") |> 
      rename(wtd = myvar) |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      drop_na()
    ) |> 

  ## s america
  bind_rows(
    nc_to_df("~/data/watertable_fan13sci/S_America_model_wtd_v2_0.05deg_CLEAN.nc", varnam = "WTD") |> 
      rename(wtd = myvar) |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |>
      drop_na()
    )

save(df_wtd, file = "data/df_wtd.RData")
```

```{r}
load("data/df_corr.RData")
load("data/df_wtd.RData")

# nc_vegtype <- read_nc_onefile("~/data/landcover/modis_landcover__LPDAAC__v5.1__0.05deg__2010.nc", varnam = "landcover")

df_pred <- df_corr |> 
  mutate(bias_40 = -log(cwdx40 / cwd_lue0_SIF)) |> 
  dplyr::select(lon, lat, cwdx40, cwd_lue0_SIF, cwd_lue0_fet, bias_40) |> 
  drop_na() |> 

  ## read GTI
  left_join(
    nc_to_df("~/data/gti_marthews/ga2_0_05deg.nc", varnam = "gti") |> 
      drop_na() |> 
      rename(gti = myvar) |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)),
    by = c("lon", "lat")
  ) |> 
  
  # ## read vegetation map
  # left_join(
  #   nc_to_df(nc_vegtype, varnam = "landcover") |> 
  #     rename(vegtype = myvar) |> 
  #     mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)) |> 
  #     dplyr::filter(vegtype > 0) |> 
  #     drop_na(),
  #   by = c("lon", "lat")
  # ) |> 

  ## add wtd map
  left_join(
    df_wtd |> 
      drop_na(),
    by = c("lon", "lat")
  ) |> 

  ## read irrigation map
  left_join(
    df_irr <- nc_to_df("~/data/irrigation/gmia_v5_aai_pct_0_05deg.nc", varnam = "aai") |> 
      drop_na() |> 
      rename(aai = myvar) |> 
      mutate(lon = round(lon, digits = 3), lat = round(lat, digits = 3)),
    by = c("lon", "lat")
  )

save(df_pred, file = "data/df_pred.RData")  
```

Distribution of values

```{r}
df_pred |> 
  mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF, coef = 10)) |> 
  ggplot(aes(x = cwd_lue0_SIF, y = ..count..)) +
  geom_histogram()
```

#### Residuals

```{r}
load("data/df_pred.RData")

df_pred <- df_pred |> 
  mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF, coef = 10)) |> 
  left_join(df_corr |> dplyr::select(lon, lat, forest), by = c("lon", "lat")) |> 
  drop_na()

df_pred |> 
  ggplot(aes(aai, bias_40)) +
  geom_hex(bins = 100) +
  scale_fill_gradientn(
    colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5)) +
  geom_hline(yintercept = 0, linetype = "dotted")

df_pred |> 
  ggplot(aes(gti, bias_40)) +
  geom_hex(bins = 100) +
  scale_fill_gradientn(
    colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5)) +
  geom_hline(yintercept = 0, linetype = "dotted")

df_pred |> 
  ggplot(aes(wtd, bias_40)) +
  geom_hex(bins = 100) +
  scale_fill_gradientn(
    colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5)) +
  geom_hline(yintercept = 0, linetype = "dotted")

df_pred |> 
  ggplot(aes(forest, bias_40)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, linetype = "dotted")
```

#### Linear regression

Fit a simple multivariate linear model.

```{r}
library(recipes)
library(caret)

load("data/df_pred.RData")

df_sub <- df_pred |> 
  
  ## remove pixels with a lot of irrigation areas
  mutate(aai = ifelse(is.na(aai), 0, aai)) |> 
  dplyr::filter(aai < 0.5) |> 
  
  # ## central asia only
  # dplyr::filter(lon > 45 & lon < 95 & lat > 25 & lat < 47.5) |> 

  # mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF, coef = 10)) |> 
  left_join(df_corr |> dplyr::select(lon, lat, forest), by = c("lon", "lat")) |> 
  mutate(forest = as.factor(forest)) |> 
  mutate(cwd_lue0_SIF_log = log(cwd_lue0_SIF), cwdx40_log = log(cwdx40))

linmod1 <- lm(cwd_lue0_SIF ~ cwdx40 + gti + wtd + factor(forest), data = df_sub)
summary(linmod1)

linmod2 <- lm(cwd_lue0_SIF_log ~ cwdx40_log + gti + wtd + factor(forest), data = df_sub)
summary(linmod2)

linmod3 <- lm(log(cwd_lue0_SIF) ~ log(cwdx40), data = df_sub)
summary(linmod3)

linmod4 <- lm(cwd_lue0_SIF_log ~ cwdx40_log, data = df_sub)
summary(linmod4)

linmod2 <- lm(cwd_lue0_SIF_log ~ cwdx40, data = df_sub)
summary(linmod2)

## with caret
myrecipe <- recipe(cwd_lue0_SIF ~ cwdx40 + gti + wtd  + forest, data = df_sub) |> 
  step_dummy(forest) |> 
  step_BoxCox(cwd_lue0_SIF, cwdx40)

traincotrlParams <- caret::trainControl( method = "none",
                                         savePredictions = "final"   # predictions on each validation resample are then available as modl$pred$Resample
                                         )
modl <- train(myrecipe,
              data = df_sub,
              method = "lm",
              trControl = traincotrlParams
              )

save(modl, file = "data/modl_lm_allvars.RData")

df_sub$.pred1 <- predict(linmod1, newdata = df_sub)
df_sub$.pred2 <- predict(linmod2, newdata = df_sub)
```

```{r}
out <- df_sub |> 
  # dplyr::filter(forest) |> 
  # mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF, coef = 10)) |> 
  rbeni::analyse_modobs2(".pred2", "cwd_lue0_SIF_log", type = "hex", plot_linmod = FALSE)
gg40 <- out$gg +
  scale_x_log10() + 
  scale_y_log10() +
  labs(title = "Full model", 
       x = expression(italic(S)[FULL] ~ " (mm)"), 
       y = expression(italic(S)[dSIF] ~ " (mm)")) +
  ylim(0.1, 12) + xlim(0.1, 12)
gg40
ggsave("fig/corr_FULL.pdf", width = 6, height = 5)
ggsave("fig/corr_FULL.png", width = 6, height = 5)
```

#### Random forest

With random forest - works nicely: increasing the R2 from 0.45 to 0.75.

```{r}
library(caret)
library(recipes)

load("data/df_pred.RData")

df_sub <- df_pred |> 
  mutate(aai = ifelse(is.na(aai), 0, aai)) |> 
  dplyr::filter(aai < 0.5) |> 
  
  ## central asia only
  dplyr::filter(lon > 45 & lon < 95 & lat > 25 & lat < 47.5) |> 
  mutate(cwd_lue0_SIF = remove_outliers(cwd_lue0_SIF, coef = 10)) |> 
  left_join(df_corr |> dplyr::select(lon, lat, forest), by = c("lon", "lat")) |> 
  drop_na()

set.seed(123)  # for reproducibility
index <- createDataPartition(df_pred$cwdx40, p = 0.7, list = FALSE)
df_train <- df_sub |> 
  slice(index)
df_test <- df_sub |> 
  slice(-index)

traincotrlParams <- caret::trainControl( method = "cv",
                                         number = 5,
                                         savePredictions = "final"   # predictions on each validation resample are then available as modl$pred$Resample
                                         )

hyper_grid <- expand.grid(.mtry = c(2),
                          .splitrule = "variance",
                          .min.node.size = c(10)
                          )

# hyper_grid <- expand.grid( .decay = c(0.1), .size = 20 )

# myrecipe <- recipe(cwd_lue0_SIF ~ cwdx40 + gti + wtd + aai + forest, data = df_pred) |>
#       step_center(all_numeric(), -all_outcomes()) |>
#       step_scale(all_numeric(), -all_outcomes()) |>
#       step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

myrecipe <- recipe(cwd_lue0_SIF ~ cwdx40 + gti + wtd + aai + forest, data = df_sub)

modl <- train(myrecipe,
              data = df_train,
              method = "ranger", # "nnet", # 
              trControl = traincotrlParams,
              tuneGrid = hyper_grid,
              metric = "RMSE",
              importance = "permutation"  # ranger-specific, enables VIP
              )

modl

save(modl, file = "data/modl_rf_allvars_casia.RData")

df_test$.pred <- predict(modl, newdata = df_test)

df_test |> 
  analyse_modobs2(".pred", "cwd_lue0_SIF", type = "heat")
```

Interpret model.

```{r}
library(pdp)
df_pd_gti <- partial(modl, pred.var = "gti")
df_pd_aai <- partial(modl, pred.var = "aai")
df_pd_wtd <- partial(modl, pred.var = "wtd")
df_pd_forest <- partial(modl, pred.var = "forest")

save(df_pd_gti, file = "data/df_pd_gti.RData")
save(df_pd_aai, file = "data/df_pd_aai.RData")
save(df_pd_wtd, file = "data/df_pd_wtd.RData")
save(df_pd_forest, file = "data/df_pd_forest.RData")

df_pd_gti |> 
  ggplot(aes(gti, yhat)) +
  geom_line()

df_pd_aai |> 
  ggplot(aes(aai, yhat)) +
  geom_line()

df_pd_wtd |> 
  ggplot(aes(wtd, yhat)) +
  geom_line()

df_pd_forest |> 
  ggplot(aes(forest, yhat)) +
  geom_point()
```

```{r}
library(vip)
vip(modl$finalModel)
```

```{r}
nc_landcover <- read_nc_onefile("~/data/landcover/modis_landcover__LPDAAC__v5.1__0.05deg__2010.nc", varnam = "landcover")

igbp_cols <- function(x, direction = 1){

  library(plotKML)
  library(gplots)

  data(worldgrids_pal)

  worldgrids_pal$IGBP["Water "] <- col2hex("lightblue1")  # rgb(1,0,0)
  worldgrids_pal$IGBP["Unclassified "] <- col2hex("white")
  worldgrids_pal$IGBP["Fill Value "] <- col2hex("white")
  worldgrids_pal$IGBP["Evergreen Broadleaf forest "] <- col2hex("forestgreen")
  worldgrids_pal$IGBP["Evergreen Needleleaf forest "] <- col2hex("dodgerblue4")
  worldgrids_pal$IGBP["Deciduous Needleleaf forest "] <- col2hex("dodgerblue2")
  worldgrids_pal$IGBP["Deciduous Broadleaf forest "] <- col2hex("springgreen3")
  worldgrids_pal$IGBP["Woody savannas "] <- col2hex("darkorange")
  worldgrids_pal$IGBP["Grasslands "] <- col2hex("khaki3")
  worldgrids_pal$IGBP["Permanent wetlands "] <- col2hex("violetred")
  # worldgrids_pal$IGBP["Mixed forest "] <- col2hex("springgreen4")

  return(unname(worldgrids_pal$IGBP[1:17]))
}

gg <- nc_landcover |>
  nc_to_df(varnam = "landcover") |>
  plot_map3(varnam = "myvar", lonmin = 45, lonmax = 95, latmin = 25, latmax = 47.5,
            spacing = "constant",
            breaks = 0:17,
            combine = FALSE,
            colorscale = igbp_cols,
            legend_title = ""
            )


# filnam <- "/alphadata01/bstocker/data/MODIS_Land-Cover-Type-MCD12Q1/v051/500m_sinusoidal_1y/processed/regrid/modis.land-cover-type.2010.tif"
filnam <- "~/data/landcover/modis_landcover__LPDAAC__v5.1__0.05deg__2010.nc"
rasta <- raster( filnam )

## change spatial resolution of rasta object
mostfrequent <- function(vec, na.rm=TRUE) { 
  out <- as.numeric(names(which.max(table(vec))))
  return(out) 
}
rasta_agg <- aggregate( x = rasta, fact = 10, fun = mostfrequent  )

plot_map3(rasta_agg)


## write raster object to netcdf
writeRaster( mybrick, filename="landcover_modis_2010.nc", format="CDF" )

plot( rasta_agg, col=worldgrids_pal$IGBP, legend=FALSE, axes=FALSE )  # , xlim = c(-10, 15), ylim = c(39, 55)
plot( rasta_agg,
  legend.only   =TRUE,
  col           =worldgrids_pal$IGBP,
  legend.width  =1,
  legend.shrink =0.75,
  axis.args     =list(at=c(0:length(worldgrids_pal$IGBP)),labels=as.character(c(0:length(worldgrids_pal$IGBP))),cex.axis=0.6),
  legend.args   =list(text='IGBP land cover class',side=4,font=2,line=2.5,cex=1.0)
  )
```

### Bias by GTI

Looking at the bias calculated in chunk above, and testing whether it correlates with topography (TOPMODEL) index GTI.

```{r}
## central asia cutout
df_gti <- nc_to_df("~/data/gti_marthews/ga2_casia_05deg.nc", varnam = "Band1") |> 
  rename(gti = Band1) |> 
  left_join(df_corr_bias, by = c("lon", "lat"))

df_gti |> 
  analyse_modobs2("gti", "bias_20", type = "hex")

save(df_gti, file = "data/df_gti.RData")
```

### Correlations

For different return period selections

#### SIF

Correlation plots for different return periods with SIF.

```{r}
load("data/df_corr.RData")

## 80 year return period
out <- df_corr |> 
  filter(cwdx80 < 2500) |> 
  # mutate(cwd_lue0_nSIF = remove_outliers(cwd_lue0_nSIF, coef = 10)) |> 
  analyse_modobs2("cwdx80", "cwd_lue0_nSIF", type = "hex", plot_linmod = FALSE)

gg80_sif <- out$gg +
  scale_x_continuous(expand = c(0,0), limits = c(0,1200)) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,1200)) +
  labs(x = expression(italic(S)[CWDX80] ~ " (mm)"), 
       y = expression(italic(S)[dSIF] ~ " (mm)")) +
  scale_fill_gradientn(
        colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), 
        trans = "log", breaks = c(1, 10, 100, 1000, 10000))
gg80_sif
ggsave("fig/corr_cwd_lue0_nSIF_cwdx80.pdf", width = 6, height = 5)
ggsave("fig/corr_cwd_lue0_nSIF_cwdx80.png", width = 6, height = 5)
```

#### EF

Correlation plots for different return periods with evaporative fraction.

```{r}
## 80 year return period
out <- df_corr |> 
  dplyr::filter(forest) |>
  mutate(cwd_lue0_fet = remove_outliers(cwd_lue0_fet, coef = 10)) |> 
  analyse_modobs2("cwdx80", "cwd_lue0_fet", type = "hex", plot_linmod = FALSE)
gg80_ef <- out$gg +
  scale_x_continuous(expand = c(0,0), limits = c(0,1200)) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,1200)) +
  labs(x = expression(italic(S)[CWDX80] ~ " (mm)"), 
       y = expression(italic(S)[dEF] ~ " (mm)")) +
  scale_fill_gradientn(
        colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), 
        trans = "log", breaks = c(1, 10, 100, 1000, 10000))
gg80_ef
ggsave("fig/corr_cwd_lue0_fet_cwdx80.pdf", width = 6, height = 5)
ggsave("fig/corr_cwd_lue0_fet_cwdx80.png", width = 6, height = 5)

## publication figure
plot_grid(gg80_sif, gg80_ef, ncol = 2, labels = c('a', 'b'))
ggsave("fig/corr_cwd_lue0_fet_sif_cwdx80.pdf", width = 12, height = 5)
ggsave("fig/corr_cwd_lue0_fet_sif_cwdx80.png", width = 12, height = 5)
```

### Correlation by biomes

```{r}
load("data/df_corr.RData")

df_corr_biome <- df_corr |> 
  dplyr::filter(biome_name != "Mangroves") |> 
  group_by(biome_name) |> 
  summarise(q10_cwdx80 = quantile(cwdx80, probs = 0.10, na.rm = TRUE),
            q25_cwdx80 = quantile(cwdx80, probs = 0.25, na.rm = TRUE),
            q50_cwdx80 = quantile(cwdx80, probs = 0.50, na.rm = TRUE),
            q75_cwdx80 = quantile(cwdx80, probs = 0.75, na.rm = TRUE),
            q90_cwdx80 = quantile(cwdx80, probs = 0.90, na.rm = TRUE),
            
            q10_cwd_lue0_SIF = quantile(cwd_lue0_SIF, probs = 0.10, na.rm = TRUE),
            q25_cwd_lue0_SIF = quantile(cwd_lue0_SIF, probs = 0.25, na.rm = TRUE),
            q50_cwd_lue0_SIF = quantile(cwd_lue0_SIF, probs = 0.50, na.rm = TRUE),
            q75_cwd_lue0_SIF = quantile(cwd_lue0_SIF, probs = 0.75, na.rm = TRUE),
            q90_cwd_lue0_SIF = quantile(cwd_lue0_SIF, probs = 0.90, na.rm = TRUE),
            
            q10_cwd_lue0_fet = quantile(cwd_lue0_fet, probs = 0.10, na.rm = TRUE),
            q25_cwd_lue0_fet = quantile(cwd_lue0_fet, probs = 0.25, na.rm = TRUE),
            q50_cwd_lue0_fet = quantile(cwd_lue0_fet, probs = 0.50, na.rm = TRUE),
            q75_cwd_lue0_fet = quantile(cwd_lue0_fet, probs = 0.75, na.rm = TRUE),
            q90_cwd_lue0_fet = quantile(cwd_lue0_fet, probs = 0.90, na.rm = TRUE)
            )

## Median works particularly generally well!
## dSIF
out <- df_corr_biome |> 
  analyse_modobs2("q10_cwdx80", "q10_cwd_lue0_SIF", label = FALSE, id = "biome_name", nlabels = 3)
gg_sif_10 <- out$gg + labs(title = "10% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dSIF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q25_cwdx80", "q25_cwd_lue0_SIF", label = FALSE, id = "biome_name", nlabels = 3)
gg_sif_25 <- out$gg + labs(title = "25% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dSIF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q50_cwdx80", "q50_cwd_lue0_SIF", label = FALSE, id = "biome_name", nlabels = 3)
gg_sif_50 <- out$gg + labs(title = "50% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dSIF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q75_cwdx80", "q75_cwd_lue0_SIF", label = FALSE, id = "biome_name", nlabels = 3)
gg_sif_75 <- out$gg + labs(title = "75% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dSIF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q90_cwdx80", "q90_cwd_lue0_SIF", label = FALSE, id = "biome_name", nlabels = 3)
gg_sif_90 <- out$gg + labs(title = "90% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dSIF] ~ " (mm)"))

## dEF
out <- df_corr_biome |> 
  analyse_modobs2("q10_cwdx80", "q10_cwd_lue0_fet", label = FALSE, id = "biome_name", nlabels = 3)
gg_ef_10 <- out$gg + labs(title = "10% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dEF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q25_cwdx80", "q25_cwd_lue0_fet", label = FALSE, id = "biome_name", nlabels = 3)
gg_ef_25 <- out$gg + labs(title = "25% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dEF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q50_cwdx80", "q50_cwd_lue0_fet", label = FALSE, id = "biome_name", nlabels = 3)
gg_ef_50 <- out$gg + labs(title = "50% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dEF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q75_cwdx80", "q75_cwd_lue0_fet", label = FALSE, id = "biome_name", nlabels = 3)
gg_ef_75 <- out$gg + labs(title = "75% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dEF] ~ " (mm)"))

out <- df_corr_biome |> 
  analyse_modobs2("q90_cwdx80", "q90_cwd_lue0_fet", label = FALSE, id = "biome_name", nlabels = 3)
gg_ef_90 <- out$gg + labs(title = "90% quantile by biome",
              x = expression(italic(S)[CWDX80] ~ " (mm)"),
              y = expression(italic(S)[dEF] ~ " (mm)"))

save(gg_sif_50, file = "data/gg_sif_50.RData")
save(gg_ef_50, file = "data/gg_ef_50.RData")
```

Combined plot. Run `rsip.Rmd` before to get plot file for comparison against RSIP.

```{r}
library(patchwork)
load("data/80.RData")
load("data/gg_rsip_25.RData")
load("data/gg_rsip_50.RData")
load("data/gg_rsip_75.RData")
load("data/gg_rsip_90.RData")

load("data/gg_sj02_10.RData")
load("data/gg_sj02_25.RData")
load("data/gg_sj02_50.RData")
load("data/gg_sj02_75.RData")
load("data/gg_sj02_90.RData")

(gg_sj02_10 + gg_sj02_50 + gg_sj02_90) /
  (gg_rsip_10 + gg_rsip_50 + gg_rsip_90) /
  (gg_sif_10 + gg_sif_50 + gg_sif_90) /
  (gg_ef_10 + gg_ef_50 + gg_ef_90) + 
  plot_annotation(tag_levels = 'a') &  # , tag_prefix = '(', tag_suffix = ')'
  theme(plot.tag = element_text(face = "bold"))

ggsave("fig/modobs_quantiles_biome.pdf", width = 15, height = 15)
ggsave("fig/modobs_quantiles_biome.png", width = 15, height = 15)
```

### S by biome ridge plot

Comparing S from different methods

#### SIF

```{r}
load("data/df_corr.RData")

df_corr |> 
  dplyr::select(biome_name, obs = cwd_lue0_SIF, mod = cwdx40) |>
  drop_na() |> 
  tidyr::pivot_longer(cols = c(mod, obs), names_to = "source", values_to = "cwdx") |> 
  dplyr::filter(biome_name!="Mangroves") |>   
  ggplot(
    aes(x = cwdx, y = biome_name, color = source, point_color = source, fill = source)
    ) +
  geom_density_ridges(jittered_points = FALSE) +
  scale_y_discrete(expand = c(0, 0)) +
  # scale_x_continuous(expand = c(0, 0), name = expression(italic(S)[CWDX20]), limits = c(0,1000)) +
  scale_fill_manual(
    values = c("#D55E0050", "#0072B250"), 
    labels = c(expression(italic(S)[CWDX40]), 
               expression(italic(S)[dSIF]))) +
  scale_color_manual(values = c("#D55E00", "#0072B2"), guide = "none") +
  scale_discrete_manual("point_color", values = c("#D55E00", "#0072B2"), guide = "none") +
  coord_cartesian(clip = "off") +
  guides(fill = guide_legend(
    override.aes = list(
      fill = c("#D55E00A0", "#0072B2A0"),
      color = NA, point_color = NA, name = "")
    )
  ) +
  ggtitle(expression(italic(S)[CWDX40] ~ "and" ~ italic(S)[dSIF])) +
  theme_ridges(center = TRUE) +
  # scale_x_continuous(expand = c(0, 0), name = "Rooting depth (mm)", limits = c(0,1000)) +
  scale_x_log10(name = expression(italic(S)[CWDX40] ~ "and" ~ italic(S)[dSIF] ~ " (mm)"),
                breaks = c(1, 10, 100, 1000),
                expand = c(0, 0),
                limits = c(10, 10000)) +
  labs(y = "")

ggsave("fig/modobs_ridges_cwdx_dsif.pdf", width = 15, height = 10)
ggsave("fig/modobs_ridges_cwdx_dsif.png", width = 15, height = 10)
```

#### EF

```{r}
df_corr |> dplyr::select(biome_name, obs = cwd_lue0_fet, mod = cwdx40) |>
  drop_na() |> 
  tidyr::pivot_longer(cols = c(mod, obs), names_to = "source", values_to = "cwdx") |> 
  dplyr::filter(biome_name!="Mangroves") |>   
  ggplot(
    aes(x = cwdx, y = biome_name, color = source, point_color = source, fill = source)
    ) +
  geom_density_ridges(jittered_points = FALSE) +
  scale_y_discrete(expand = c(0, 0)) +
  # scale_x_continuous(expand = c(0, 0), name = expression(italic(S)[CWDX20]), limits = c(0,1000)) +
  scale_fill_manual(
    values = c("#D55E0050", "#0072B250"), 
    labels = c(expression(italic(S)[CWDX40]), 
               expression(italic(S)[dEF]))) +
  scale_color_manual(values = c("#D55E00", "#0072B2"), guide = "none") +
  scale_discrete_manual("point_color", values = c("#D55E00", "#0072B2"), guide = "none") +
  coord_cartesian(clip = "off") +
  guides(fill = guide_legend(
    override.aes = list(
      fill = c("#D55E00A0", "#0072B2A0"),
      color = NA, point_color = NA, name = "")
    )
  ) +
  ggtitle(expression(italic(S)[CWDX40] ~ "and" ~ italic(S)[dEF])) +
  theme_ridges(center = TRUE) +
  scale_x_log10(name = expression(italic(S)[CWDX40] ~ "and" ~ italic(S)[dEF] ~ " (mm)"), 
                breaks = c(1, 10, 100, 1000),
                expand = c(0, 0),
                limits = c(10, 10000)) +
  labs(y = "")

ggsave("fig/modobs_ridges_cwdx_fet.pdf", width = 15, height = 10)
ggsave("fig/modobs_ridges_cwdx_fet.png", width = 15, height = 10)
```

## Sample checks

Check some relationships at FLUXNET2015 site locations. This is implemented by script `rscript_sample_checks_fluxnet2015sites.R`.
```{r}
lon_hires <- seq(-179.975, 179.975, by = 0.05)
ilon <- purrr::map_int(as.list(df$lon), ~which.min(abs(. - lon_hires)))

library(ingestr)
library(segmented)
source("R/calc_cwd_et0_byilon.R")

dfs <- siteinfo_fluxnet2015 |> 
  dplyr::select(sitename, lon, lat) |> 
  
  ## get hires longitude index
  mutate(ilon = ilon) |> 
  group_by(ilon) |> 
  nest() |> 
  rename(siteinfo = data) |> 
  
  ungroup() |> 
  slice(1) |> 
  
  mutate(data = purrr::map2(ilon, siteinfo, ~calc_cwd_et0_byilon(.x, siteinfo = .y, drop_data = FALSE, overwrite = TRUE, do_plot = TRUE)))

saveRDS(dfs, file = "data/sample_checks_fluxnet2015sites.rds")

## One plot can then be shown as
dfs$data[[1]]$out_lue0_fet[[1]]$gg + labs(subtitle = dfs$siteinfo[[1]]$sitename)
```


## Publication figures

```{r}
load("data/gg_fig1a.Rdata")
load("data/gg_fig1c.Rdata")
load("data/gg_fig1b.Rdata")

plot_grid(gg_fig1a, gg_fig1b, gg_fig1_legend, ncol = 1, labels = c('a', 'b', ''), rel_heights = c(1,1,0.2))
ggsave("fig/fig1.png", width = 8, height = 8)
ggsave("fig/fig1.pdf", width = 8, height = 8)

# Fig. 5
load("data/gg_fig5a.Rdata")
load("data/gg_fig5b.Rdata")
bottom_row <- plot_grid(gg_fig5c, gg_fig5d, ncol = 2, labels = c('c', 'd'))
plot_grid(gg_fig4a, gg_fig4b, gg_fig4_legend, bottom_row, ncol = 1, labels = c('a', 'b', ''), rel_heights = c(1,1,0.25,0.7))
ggsave("fig/fig_return_period.pdf", width = 8, height = 11)
ggsave("fig/fig_return_period.png", width = 8, height = 11)

cowplot::plot_grid(gg$ggmap, gg$gglegend, ncol = 2, rel_heights = c(1, 0.12))

ggsave("fig/map_zroot_cwd80.png", width = 10, height = 5)
ggsave("fig/map_zroot_cwd80.pdf", width = 10, height = 5)

## fig 3
# top <- cowplot::plot_grid(gg_fig3a, gg_fig3a_legend, 
#                           gg_fig3b, gg_fig3b_legend, 
#                           ncol = 2, rel_widths = c(1, 0.12), labels = c('a', '', 'b', ''))
# bottom <- cowplot::plot_grid(gg_hist_cwdx80, gg_hist_zr,
#                              ncol = 2, labels = c('c', 'd'))
# cowplot::plot_grid(top, bottom, nrow = 2, rel_heights = c(1, 0.3))

cowplot::plot_grid(gg_fig3a, gg_fig3a_legend, 
                   gg_fig3b, gg_fig3b_legend, 
                   ncol = 2, rel_widths = c(1, 0.08), labels = c('a', '', 'b', ''))
ggsave("fig/fig3.png", width = 10, height = 8)
ggsave("fig/fig3.pdf", width = 10, height = 8)
```
